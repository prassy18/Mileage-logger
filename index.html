<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Trip Logger</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🚗</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%234CAF50'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>🚗</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Trip Logger">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 414px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }

        .tab-content {
            display: none;
            padding: 20px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .section-divider {
            border-top: 1px solid #dee2e6;
            margin: 30px 0;
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .record {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .record-date {
            font-weight: 600;
            color: #4CAF50;
        }

        .record-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }

        .record-details {
            font-size: 14px;
            line-height: 1.6;
        }

        .record-details strong {
            color: #333;
        }

        .stats {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .stats h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .font-size-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            min-width: 45px;
        }

        .font-size-small {
            font-size: 14px;
        }

        .font-size-medium {
            font-size: 16px;
        }

        .font-size-large {
            font-size: 18px;
        }

        .font-size-xlarge {
            font-size: 20px;
        }

        .font-size-small input, .font-size-small textarea, .font-size-small select {
            font-size: 14px;
            padding: 10px;
        }

        .font-size-medium input, .font-size-medium textarea, .font-size-medium select {
            font-size: 16px;
            padding: 12px;
        }

        .font-size-large input, .font-size-large textarea, .font-size-large select {
            font-size: 18px;
            padding: 15px;
        }

        .font-size-xlarge input, .font-size-xlarge textarea, .font-size-xlarge select {
            font-size: 20px;
            padding: 18px;
        }

        .font-size-small .btn {
            font-size: 14px;
            padding: 12px 25px;
        }

        .font-size-medium .btn {
            font-size: 16px;
            padding: 15px 30px;
        }

        .font-size-large .btn {
            font-size: 18px;
            padding: 18px 35px;
        }

        .font-size-xlarge .btn {
            font-size: 20px;
            padding: 20px 40px;
        }

        .font-size-small .form-group label {
            font-size: 13px;
            font-weight: 500;
        }

        .font-size-medium .form-group label {
            font-size: 15px;
            font-weight: 500;
        }

        .font-size-large .form-group label {
            font-size: 17px;
            font-weight: 600;
        }

        .font-size-xlarge .form-group label {
            font-size: 19px;
            font-weight: 600;
        }

        .font-size-small .tab {
            font-size: 13px;
            padding: 12px;
        }

        .font-size-medium .tab {
            font-size: 15px;
            padding: 15px;
        }

        .font-size-large .tab {
            font-size: 17px;
            padding: 18px;
        }

        .font-size-xlarge .tab {
            font-size: 19px;
            padding: 20px;
        }

        .font-size-small .record-details {
            font-size: 13px;
        }

        .font-size-medium .record-details {
            font-size: 15px;
        }

        .font-size-large .record-details {
            font-size: 17px;
        }

        .font-size-xlarge .record-details {
            font-size: 19px;
        }

        .font-size-small .header h1 {
            font-size: 20px;
        }

        .font-size-medium .header h1 {
            font-size: 24px;
        }

        .font-size-large .header h1 {
            font-size: 28px;
        }

        .font-size-xlarge .header h1 {
            font-size: 32px;
        }

        .font-size-xlarge .summary-grid,
        .font-size-xlarge .stat-grid {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .font-size-xlarge .history-summary-grid {
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .vehicle-info-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #333;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .vehicle-info-card h3 {
            margin-bottom: 15px;
            text-align: center;
            color: #4CAF50;
        }

        .vehicle-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .vehicle-info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            word-wrap: break-word;
        }

        .vehicle-info-label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .vehicle-info-value {
            font-size: 16px;
            font-weight: 500;
        }

        .export-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .backup-reminder {
            background: linear-gradient(135deg, #ff9500, #ff7b00);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .backup-status {
            background: #e8f5e8;
            color: #2d5016;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .import-section {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px dashed #4CAF50;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 20px;
        }

        .monthly-summary {
            background: linear-gradient(135deg, #6f42c1, #5a32a3);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .monthly-history {
            background: linear-gradient(135deg, #e83e8c, #d91a72);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .history-month {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .history-month:last-child {
            margin-bottom: 0;
        }

        .month-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .summary-item {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
        }

        .summary-value {
            display: block;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .history-summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .history-summary-item {
            text-align: center;
            background: rgba(255,255,255,0.05);
            padding: 8px;
            border-radius: 6px;
        }

        .history-summary-value {
            display: block;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .history-summary-label {
            font-size: 10px;
            opacity: 0.8;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            width: 100%;
            font-size: 16px;
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="font-size-toggle" onclick="toggleFontSize()" id="fontToggle">A+</button>
        
        <div class="header">
            <h1>🚗 Trip Logger</h1>
            <p>Track your journeys and expenses</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('trips')">Trip Logs</button>
            <button class="tab" onclick="showTab('fuel')">Fuel Logs</button>
            <button class="tab" onclick="showTab('service')">Service</button>
            <button class="tab" onclick="showTab('stats')">Statistics</button>
            <button class="tab" onclick="showTab('vehicle')">Vehicle</button>
        </div>

        <div id="trips" class="tab-content active">
            <form id="tripForm">
                <div class="form-group">
                    <label for="tripDate">Date</label>
                    <input type="date" id="tripDate" required>
                </div>
                <div class="form-group">
                    <label for="startingLocation">Starting Location *</label>
                    <select id="startingLocation" onchange="handleLocationChange()" required>
                        <option value="">Select starting location...</option>
                        <option value="Koyambedu Home">🏠 Koyambedu Home</option>
                        <option value="Kumbakonam Srivatsam">🏡 Kumbakonam Srivatsam</option>
                        <option value="Bangalore Amigo">🏢 Bangalore Amigo</option>
                        <option value="Other">✏️ Other (specify below)</option>
                    </select>
                </div>
                <div class="form-group" id="customLocationGroup" style="display: none;">
                    <label for="customLocation">Custom Starting Location</label>
                    <input type="text" id="customLocation" placeholder="Enter custom location...">
                </div>
                <div class="form-group">
                    <label for="tripPurpose">Trip Purpose *</label>
                    <select id="tripPurpose" required>
                        <option value="">Select purpose...</option>
                        <option value="Shopping">🛒 Shopping / Market</option>
                        <option value="Family Visit">👨‍👩‍👧‍👦 Family Visit</option>
                        <option value="Religious">🕉️ Religious / Temple</option>
                        <option value="Banking">🏦 Banking / Official Work</option>
                        <option value="Social">👥 Social / Friends</option>
                        <option value="Leisure">🎯 Leisure / Entertainment</option>
                        <option value="Maintenance">🔧 Car Service / Maintenance</option>
                        <option value="Medical">🏥 Medical / Doctor Visit</option>
                        <option value="Other">📝 Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="startOdometer">Start Odometer (km) *</label>
                    <input type="number" id="startOdometer" placeholder="e.g., 45000" required>
                </div>
                <div class="form-group">
                    <label for="endOdometer">End Odometer (km) *</label>
                    <input type="number" id="endOdometer" placeholder="e.g., 45150" required>
                </div>
                <div class="form-group">
                    <label for="remainingRange">Remaining Range (km)</label>
                    <input type="number" id="remainingRange" placeholder="e.g., 450">
                </div>
                <div class="form-group">
                    <label for="tripNotes">Trip Notes</label>
                    <textarea id="tripNotes" placeholder="Any additional notes about the trip..."></textarea>
                </div>
                <button type="submit" class="btn">Add Trip Log</button>
            </form>

            <div class="search-box">
                <input type="text" id="tripSearch" placeholder="🔍 Search trip logs..." onkeyup="searchTrips()">
            </div>

            <div id="tripsList"></div>
        </div>

        <div id="fuel" class="tab-content">
            <form id="fuelForm">
                <div class="form-group">
                    <label for="fuelDate">Date</label>
                    <input type="date" id="fuelDate" required>
                </div>
                <div class="form-group">
                    <label for="fuelOdometer">Odometer Reading (km)</label>
                    <input type="number" id="fuelOdometer" placeholder="e.g., 45075" required>
                </div>
                <div class="form-group">
                    <label for="rangeBefore">Range Before Fuel (km)</label>
                    <input type="number" id="rangeBefore" placeholder="e.g., 50">
                </div>
                <div class="form-group">
                    <label for="fuelAmount">Fuel Amount (Litres)</label>
                    <input type="number" step="0.01" id="fuelAmount" placeholder="e.g., 45.5" required>
                </div>
                <div class="form-group">
                    <label for="fuelCost">Cost (₹)</label>
                    <input type="number" step="0.01" id="fuelCost" placeholder="e.g., 4095.50" required>
                </div>
                <div class="form-group">
                    <label for="rangeAfter">Range After Fuel (km)</label>
                    <input type="number" id="rangeAfter" placeholder="e.g., 650">
                </div>
                <div class="form-group">
                    <label for="fuelStation">Fuel Station Info</label>
                    <input type="text" id="fuelStation" placeholder="e.g., Shell Petrol Pump, MG Road">
                </div>
                <button type="submit" class="btn">Add Fuel Log</button>
            </form>

            <div class="search-box">
                <input type="text" id="fuelSearch" placeholder="🔍 Search fuel logs..." onkeyup="searchFuel()">
            </div>

            <div id="fuelList"></div>
        </div>
        
        <div id="service" class="tab-content">
            <form id="serviceForm">
                <div class="form-group">
                    <label for="serviceDate">Service Date</label>
                    <input type="date" id="serviceDate" required>
                </div>
                <div class="form-group">
                    <label for="serviceOdometer">Odometer Reading (km)</label>
                    <input type="number" id="serviceOdometer" placeholder="e.g., 40000" required>
                </div>
                <div class="form-group">
                    <label for="serviceCenter">Service Center</label>
                    <input type="text" id="serviceCenter" placeholder="e.g., Trident Hyundai" required>
                </div>
                <div class="form-group">
                    <label for="serviceType">Type of Service</label>
                    <select id="serviceType">
                        <option value="Periodic Maintenance">Periodic Maintenance</option>
                        <option value="Running Repair">Running Repair</option>
                        <option value="Body Work">Body Work</option>
                        <option value="Inspection">Inspection</option>
                        <option value="Wheel Alignment">Wheel Alignment & Balancing</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="workDescription">Description of Work Done</label>
                    <textarea id="workDescription" placeholder="e.g., 40,000 km service, AC gas top-up"></textarea>
                </div>
                <div class="form-group">
                    <label for="partsReplaced">Parts Replaced / Used</label>
                    <textarea id="partsReplaced" placeholder="e.g., Engine oil, oil filter, air filter"></textarea>
                </div>
                <div class="form-group">
                    <label for="serviceCost">Total Cost (₹)</label>
                    <input type="number" step="0.01" id="serviceCost" placeholder="e.g., 5500.00" required>
                </div>
                <div class="form-group">
                    <label for="invoiceNumber">Invoice/Bill Number</label>
                    <input type="text" id="invoiceNumber" placeholder="Enter invoice number (optional)">
                </div>
                <button type="submit" class="btn">Add Service Log</button>
            </form>

            <div class="section-divider"></div>

            <h3>🛠️ Service History</h3>
            <div id="serviceLogList"></div>
        </div>

        <div id="stats" class="tab-content">
            <div id="backupReminder" class="backup-reminder" style="display: none;">
                <h3>⚠️ Backup Reminder</h3>
                <p>It's been a while since your last backup. Don't lose your data!</p>
                <button class="btn btn-small" onclick="autoBackup()" style="background: white; color: #ff9500; margin: 5px;">Backup Now</button>
                <button class="btn btn-small" onclick="dismissBackupReminder()" style="background: rgba(255,255,255,0.2); margin: 5px;">Remind Later</button>
            </div>

            <div id="backupStatus" class="backup-status" style="display: none;">
                <strong>✅ Last backup:</strong> <span id="lastBackupDate">Never</span>
            </div>

            <div id="monthlySummary" class="monthly-summary">
                <h3>📅 This Month Summary</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="summary-value" id="monthTrips">0</span>
                        <span class="summary-label">Trips</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-value" id="monthDistance">0</span>
                        <span class="summary-label">Total KM</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-value" id="monthFuelCost">₹0</span>
                        <span class="summary-label">Fuel Cost</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-value" id="monthAvgTrip">0</span>
                        <span class="summary-label">Avg KM/Trip</span>
                    </div>
                </div>
            </div>

            <div id="monthlyHistory" class="monthly-history">
                <h3>📈 Monthly History</h3>
                <div id="historyContainer"></div>
            </div>

            <div class="import-section">
                <h3>📥 Restore from Backup</h3>
                <p>Select a backup file to restore your data</p>
                <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData()">
                <label for="importFile" class="file-input-label">Choose Backup File</label>
                <p style="font-size: 12px; margin-top: 10px; color: #666;">Supports .json backup files only</p>
            </div>

            <div id="statsContainer"></div>
            
            <div class="export-section">
                <h3>📤 Backup & Export Data</h3>
                <button class="btn" onclick="autoBackup()">🔄 Create Full Backup</button>
                <button class="btn btn-secondary" onclick="exportData('trips')">Export Trip Logs (CSV)</button>
                <button class="btn btn-secondary" onclick="exportData('fuel')">Export Fuel Logs (CSV)</button>
                <button class="btn btn-secondary" onclick="scheduleReminders()">⏰ Set Backup Reminders</button>
            </div>
        </div>

        <div id="vehicle" class="tab-content">
            <div id="vehicleInfo" class="vehicle-info-card"></div>
            
            <form id="vehicleForm">
                <h3>✏️ Edit Vehicle Details</h3>
                <div class="form-group">
                    <label for="vehicleMake">Vehicle Make</label>
                    <input type="text" id="vehicleMake" placeholder="e.g., Maruti Suzuki">
                </div>
                <div class="form-group">
                    <label for="vehicleModel">Vehicle Model</label>
                    <input type="text" id="vehicleModel" placeholder="e.g., Swift">
                </div>
                <div class="form-group">
                    <label for="vehicleYear">Model Year</label>
                    <input type="number" id="vehicleYear" placeholder="e.g., 2023">
                </div>
                <div class="form-group">
                    <label for="licensePlate">License Plate</label>
                    <input type="text" id="licensePlate" placeholder="e.g., TN 01 AB 1234">
                </div>
                <div class="form-group">
                    <label for="engineNumber">Engine Number</label>
                    <input type="text" id="engineNumber" placeholder="Enter engine number">
                </div>
                <div class="form-group">
                    <label for="chassisNumber">Chassis Number</label>
                    <input type="text" id="chassisNumber" placeholder="Enter chassis number">
                </div>
                <button type="submit" class="btn">Save Vehicle Info</button>
            </form>
            
            <div class="section-divider"></div>

            <h3>🛡️ Insurance History</h3>
            <form id="insuranceForm">
                 <div class="form-group">
                    <label for="insuranceProvider">Provider Name</label>
                    <input type="text" id="insuranceProvider" placeholder="e.g., Acko General Insurance" required>
                </div>
                <div class="form-group">
                    <label for="policyNumber">Policy Number</label>
                    <input type="text" id="policyNumber" placeholder="Enter policy number" required>
                </div>
                 <div class="form-group">
                    <label for="policyValidity">Validity (Expiry Date)</label>
                    <input type="date" id="policyValidity" required>
                </div>
                <div class="form-group">
                    <label for="coverageInfo">Coverage Information</label>
                    <textarea id="coverageInfo" placeholder="e.g., Comprehensive, Zero Depreciation..."></textarea>
                </div>
                <button type="submit" class="btn">Add Insurance Log</button>
            </form>

            <div id="insuranceLogList" style="margin-top: 20px;"></div>

        </div>

        <div id="backupModal" class="modal">
            <div class="modal-content">
                <h3>💾 Regular Backup Recommended</h3>
                <p>To keep your data safe, we recommend backing up every week. Would you like to:</p>
                <div class="modal-buttons">
                    <button class="btn btn-small" onclick="autoBackup(); closeModal()">Backup Now</button>
                    <button class="btn btn-small btn-secondary" onclick="snoozeBackup(); closeModal()">Remind in 3 Days</button>
                    <button class="btn btn-small btn-secondary" onclick="closeModal()">Later</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let trips = JSON.parse(window.localStorage?.getItem('tripLogs') || '[]');
        let fuelLogs = JSON.parse(window.localStorage?.getItem('fuelLogs') || '[]');
        let serviceLogs = JSON.parse(window.localStorage?.getItem('serviceLogs') || '[]');
        let appSettings = JSON.parse(window.localStorage?.getItem('appSettings') || '{}');
        let customLocations = JSON.parse(window.localStorage?.getItem('customLocations') || '[]');
        let vehicleDetails = JSON.parse(window.localStorage?.getItem('vehicleDetails') || '{}');
        let insuranceLogs = JSON.parse(window.localStorage?.getItem('insuranceLogs') || '[]');

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tripDate').value = today;
            document.getElementById('fuelDate').value = today;
            document.getElementById('serviceDate').value = today;
            document.getElementById('policyValidity').value = today;
            
            const fontSize = appSettings.fontSize || 'medium';
            const container = document.querySelector('.container');
            const toggle = document.getElementById('fontToggle');
            
            container.classList.add(`font-size-${fontSize}`);
            
            switch(fontSize) {
                case 'small':
                    toggle.textContent = 'A';
                    break;
                case 'medium':
                    toggle.textContent = 'A+';
                    break;
                case 'large':
                    toggle.textContent = 'A++';
                    break;
                case 'xlarge':
                    toggle.textContent = 'A-';
                    break;
            }
            
            displayTrips();
            displayFuelLogs();
            displayServiceLogs();
            displayVehicleInfo();
            displayInsuranceLogs();
            updateStats();
            populateLocationDropdown();
            checkBackupReminder();
            updateBackupStatus();
            
            setTimeout(() => {
                autoPopulateStartOdometer();
                autoPopulateFuelOdometer();
            }, 200);
        });

        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'trips') {
                setTimeout(autoPopulateStartOdometer, 100);
            } else if (tabName === 'fuel') {
                setTimeout(autoPopulateFuelOdometer, 100);
            } else if (tabName === 'stats') {
                updateStats();
            }
        }

        function toggleFontSize() {
            const container = document.querySelector('.container');
            const toggle = document.getElementById('fontToggle');
            
            container.classList.remove('font-size-small', 'font-size-medium', 'font-size-large', 'font-size-xlarge');
            
            const currentLevel = appSettings.fontSize || 'medium';
            let newLevel;
            let buttonText;
            
            switch(currentLevel) {
                case 'small':
                    newLevel = 'medium';
                    buttonText = 'A+';
                    break;
                case 'medium':
                    newLevel = 'large';
                    buttonText = 'A++';
                    break;
                case 'large':
                    newLevel = 'xlarge';
                    buttonText = 'A-';
                    break;
                case 'xlarge':
                    newLevel = 'small';
                    buttonText = 'A';
                    break;
                default:
                    newLevel = 'large';
                    buttonText = 'A++';
            }
            
            container.classList.add(`font-size-${newLevel}`);
            toggle.textContent = buttonText;
            appSettings.fontSize = newLevel;
            saveData();
        }

        function handleLocationChange() {
            const location = document.getElementById('startingLocation').value;
            const customGroup = document.getElementById('customLocationGroup');
            
            if (location === 'Other') {
                customGroup.style.display = 'block';
                document.getElementById('customLocation').setAttribute('required', 'required');
            } else {
                customGroup.style.display = 'none';
                document.getElementById('customLocation').removeAttribute('required');
                document.getElementById('customLocation').value = '';
            }
        }

        function populateLocationDropdown() {
            const locationSelect = document.getElementById('startingLocation');
            const defaultOptions = locationSelect.innerHTML;
            
            locationSelect.innerHTML = defaultOptions;
            
            customLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = `📍 ${location}`;
                locationSelect.insertBefore(option, locationSelect.lastElementChild);
            });
        }

        function saveCustomLocation(locationName) {
            if (locationName && !customLocations.includes(locationName)) {
                customLocations.push(locationName);
                saveData();
                populateLocationDropdown();
            }
        }

        function calculateTripCost(distance, tripDate) {
            if (fuelLogs.length === 0) return 0;

            const relevantFuelLogs = fuelLogs
                .filter(log => new Date(log.date) <= new Date(tripDate))
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (relevantFuelLogs.length === 0) return 0;
            
            const lastFuelLogForTrip = relevantFuelLogs[0];
            const fuelPricePerLiter = lastFuelLogForTrip.cost / lastFuelLogForTrip.amount;
            
            let fuelEfficiency = 15;
            
            if (fuelLogs.length >= 2) {
                const sortedFuels = [...fuelLogs].sort((a, b) => new Date(a.date) - new Date(b.date));
                let totalDistanceBetweenFuels = 0;
                let totalFuelUsed = 0;
                
                for (let i = 1; i < sortedFuels.length; i++) {
                    const distanceBetween = sortedFuels[i].odometer - sortedFuels[i-1].odometer;
                    if (distanceBetween > 0 && distanceBetween < 1000) {
                        totalDistanceBetweenFuels += distanceBetween;
                        totalFuelUsed += sortedFuels[i-1].amount;
                    }
                }
                
                if (totalFuelUsed > 0) {
                    fuelEfficiency = totalDistanceBetweenFuels / totalFuelUsed;
                }
            }
            
            const fuelNeeded = distance / fuelEfficiency;
            const tripCost = fuelNeeded * fuelPricePerLiter;
            
            return tripCost;
        }
        
        function updateMonthlySummary() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            updateMonthData(currentMonth, currentYear, 'current');
            updateMonthlyHistory();
        }

        function updateMonthData(month, year, type) {
            const monthTrips = trips.filter(trip => {
                const tripDate = new Date(trip.date);
                return tripDate.getMonth() === month && tripDate.getFullYear() === year;
            });
            
            const monthFuel = fuelLogs.filter(fuel => {
                const fuelDate = new Date(fuel.date);
                return fuelDate.getMonth() === month && fuelDate.getFullYear() === year;
            });
            
            const monthTripCount = monthTrips.length;
            const monthDistance = monthTrips.reduce((sum, trip) => {
                return sum + (trip.distance || (trip.endOdometer - trip.startOdometer));
            }, 0);
            const monthFuelCost = monthFuel.reduce((sum, fuel) => sum + fuel.cost, 0);
            const avgTripDistance = monthTripCount > 0 ? Math.round(monthDistance / monthTripCount) : 0;
            
            if (type === 'current') {
                document.getElementById('monthTrips').textContent = monthTripCount;
                document.getElementById('monthDistance').textContent = monthDistance;
                document.getElementById('monthFuelCost').textContent = `₹${monthFuelCost.toFixed(0)}`;
                document.getElementById('monthAvgTrip').textContent = avgTripDistance;
            }
            
            return {
                trips: monthTripCount,
                distance: monthDistance,
                fuelCost: monthFuelCost,
                avgTrip: avgTripDistance
            };
        }

        function updateMonthlyHistory() {
            const historyContainer = document.getElementById('historyContainer');
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const allMonths = new Set();
            
            trips.forEach(trip => {
                const date = new Date(trip.date);
                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                allMonths.add(monthKey);
            });
            
            fuelLogs.forEach(fuel => {
                const date = new Date(fuel.date);
                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                allMonths.add(monthKey);
            });
            
            const sortedMonths = Array.from(allMonths)
                .map(monthKey => {
                    const [year, month] = monthKey.split('-').map(Number);
                    return { year, month };
                })
                .filter(m => !(m.month === currentMonth && m.year === currentYear))
                .sort((a, b) => {
                    if (a.year !== b.year) return b.year - a.year;
                    return b.month - a.month;
                })
                .slice(0, 6);
            
            if (sortedMonths.length === 0) {
                historyContainer.innerHTML = '<p style="text-align: center; opacity: 0.8;">No historical data yet</p>';
                return;
            }
            
            historyContainer.innerHTML = sortedMonths.map(({ month, year }) => {
                const monthData = updateMonthData(month, year, 'history');
                const monthName = new Date(year, month, 1).toLocaleDateString('en-IN', { 
                    month: 'long', 
                    year: 'numeric' 
                });
                
                return `
                    <div class="history-month">
                        <div class="month-header">${monthName}</div>
                        <div class="history-summary-grid">
                            <div class="history-summary-item">
                                <span class="history-summary-value">${monthData.trips}</span>
                                <span class="history-summary-label">Trips</span>
                            </div>
                            <div class="history-summary-item">
                                <span class="history-summary-value">${monthData.distance}</span>
                                <span class="history-summary-label">KM</span>
                            </div>
                            <div class="history-summary-item">
                                <span class="history-summary-value">₹${monthData.fuelCost.toFixed(0)}</span>
                                <span class="history-summary-label">Fuel</span>
                            </div>
                            <div class="history-summary-item">
                                <span class="history-summary-value">${monthData.avgTrip}</span>
                                <span class="history-summary-label">Avg/Trip</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function autoPopulateStartOdometer() {
            if (trips.length > 0) {
                const lastTrip = trips[0];
                document.getElementById('startOdometer').value = lastTrip.endOdometer;
                document.getElementById('startOdometer').style.backgroundColor = '#e8f5e8';
                document.getElementById('startOdometer').title = `Auto-filled from last trip (${lastTrip.endOdometer} km)`;
            }
        }

        function autoPopulateFuelOdometer() {
            let lastOdometer = 0;
            
            if (trips.length > 0) {
                lastOdometer = Math.max(lastOdometer, trips[0].endOdometer);
            }
            
            if (fuelLogs.length > 0) {
                lastOdometer = Math.max(lastOdometer, fuelLogs[0].odometer);
            }
             if (serviceLogs.length > 0) {
                lastOdometer = Math.max(lastOdometer, serviceLogs[0].odometer);
            }
            
            if (lastOdometer > 0) {
                document.getElementById('fuelOdometer').value = lastOdometer;
                document.getElementById('fuelOdometer').style.backgroundColor = '#e8f5e8';
                document.getElementById('fuelOdometer').title = `Auto-filled from last entry (${lastOdometer} km)`;
            }
        }

        document.getElementById('tripForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const locationSelect = document.getElementById('startingLocation').value;
            const customLocation = document.getElementById('customLocation').value;
            const startingLocation = locationSelect === 'Other' ? customLocation : locationSelect;
            const tripPurpose = document.getElementById('tripPurpose').value;
            const startOdometer = parseInt(document.getElementById('startOdometer').value);
            const endOdometer = parseInt(document.getElementById('endOdometer').value);
            
            if (!startingLocation || !tripPurpose || !startOdometer || !endOdometer || endOdometer <= startOdometer) {
                alert('❌ Please fill all required fields correctly.');
                return;
            }
            
            const distance = endOdometer - startOdometer;
            if (distance > 2000) {
                if (!confirm(`⚠️ This trip is ${distance} km long. This seems unusually long. Continue?`)) {
                    return;
                }
            }
            
            const trip = {
                id: Date.now(),
                date: document.getElementById('tripDate').value,
                startingLocation: startingLocation,
                purpose: tripPurpose,
                startOdometer: startOdometer,
                endOdometer: endOdometer,
                distance: distance,
                remainingRange: parseInt(document.getElementById('remainingRange').value) || 0,
                notes: document.getElementById('tripNotes').value
            };
            
            if (locationSelect === 'Other' && customLocation) {
                saveCustomLocation(customLocation);
            }
            
            trips.unshift(trip);
            saveData();
            displayTrips();
            this.reset();
            document.getElementById('tripDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('customLocationGroup').style.display = 'none';
            
            setTimeout(autoPopulateStartOdometer, 100);
            alert(`✅ Trip log added successfully!`);
        });

        document.getElementById('fuelForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fuel = {
                id: Date.now(),
                date: document.getElementById('fuelDate').value,
                odometer: parseInt(document.getElementById('fuelOdometer').value),
                rangeBefore: parseInt(document.getElementById('rangeBefore').value) || 0,
                amount: parseFloat(document.getElementById('fuelAmount').value),
                cost: parseFloat(document.getElementById('fuelCost').value),
                rangeAfter: parseInt(document.getElementById('rangeAfter').value) || 0,
                station: document.getElementById('fuelStation').value
            };
            
            fuelLogs.unshift(fuel);
            // Sort all fuel logs by date after adding a new one
            fuelLogs.sort((a,b) => new Date(b.date) - new Date(a.date));
            saveData();
            displayFuelLogs();
            displayTrips(); // Refresh trips to reflect potential cost changes
            this.reset();
            document.getElementById('fuelDate').value = new Date().toISOString().split('T')[0];
            
            setTimeout(autoPopulateFuelOdometer, 100);
            alert('✅ Fuel log added successfully!');
        });
        
        document.getElementById('serviceForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const service = {
                id: Date.now(),
                date: document.getElementById('serviceDate').value,
                odometer: parseInt(document.getElementById('serviceOdometer').value),
                center: document.getElementById('serviceCenter').value,
                type: document.getElementById('serviceType').value,
                description: document.getElementById('workDescription').value,
                parts: document.getElementById('partsReplaced').value,
                cost: parseFloat(document.getElementById('serviceCost').value),
                invoice: document.getElementById('invoiceNumber').value
            };

            serviceLogs.unshift(service);
            serviceLogs.sort((a,b) => new Date(b.date) - new Date(a.date));
            saveData();
            displayServiceLogs();
            this.reset();
            document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
            alert('✅ Service log added successfully!');
        });

        document.getElementById('vehicleForm').addEventListener('submit', function(e) {
            e.preventDefault();

            vehicleDetails.make = document.getElementById('vehicleMake').value;
            vehicleDetails.model = document.getElementById('vehicleModel').value;
            vehicleDetails.year = document.getElementById('vehicleYear').value;
            vehicleDetails.licensePlate = document.getElementById('licensePlate').value;
            vehicleDetails.engineNumber = document.getElementById('engineNumber').value;
            vehicleDetails.chassisNumber = document.getElementById('chassisNumber').value;

            saveData();
            displayVehicleInfo();

            alert('✅ Vehicle information saved successfully!');
        });

        document.getElementById('insuranceForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const insurance = {
                id: Date.now(),
                provider: document.getElementById('insuranceProvider').value,
                policyNumber: document.getElementById('policyNumber').value,
                validity: document.getElementById('policyValidity').value,
                coverage: document.getElementById('coverageInfo').value
            };

            insuranceLogs.unshift(insurance);
            insuranceLogs.sort((a,b) => new Date(b.validity) - new Date(a.validity));
            saveData();
            displayInsuranceLogs();
            this.reset();
            document.getElementById('policyValidity').value = new Date().toISOString().split('T')[0];
            alert('✅ Insurance log added successfully!');
        });

        function saveData() {
            try {
                // Ensure all logs are sorted by date before saving
                trips.sort((a,b) => new Date(b.date) - new Date(a.date));
                fuelLogs.sort((a,b) => new Date(b.date) - new Date(a.date));
                serviceLogs.sort((a,b) => new Date(b.date) - new Date(a.date));

                window.localStorage?.setItem('tripLogs', JSON.stringify(trips));
                window.localStorage?.setItem('fuelLogs', JSON.stringify(fuelLogs));
                window.localStorage?.setItem('serviceLogs', JSON.stringify(serviceLogs));
                window.localStorage?.setItem('appSettings', JSON.stringify(appSettings));
                window.localStorage?.setItem('customLocations', JSON.stringify(customLocations));
                window.localStorage?.setItem('vehicleDetails', JSON.stringify(vehicleDetails));
                window.localStorage?.setItem('insuranceLogs', JSON.stringify(insuranceLogs));
            } catch (e) {
                console.warn('Could not save to localStorage:', e);
            }
        }

        function checkBackupReminder() {
            const now = new Date().getTime();
            const lastBackup = appSettings.lastBackupDate || 0;
            const backupInterval = 7 * 24 * 60 * 60 * 1000;
            const reminderInterval = 3 * 24 * 60 * 60 * 1000;
            
            if (now - lastBackup > backupInterval) {
                const lastReminder = appSettings.lastReminderDate || 0;
                if (now - lastReminder > reminderInterval) {
                    showBackupReminder();
                }
            }
        }

        function showBackupReminder() {
            const totalEntries = trips.length + fuelLogs.length;
            if (totalEntries >= 5) {
                document.getElementById('backupReminder').style.display = 'block';
                document.getElementById('backupModal').style.display = 'block';
            }
        }

        function dismissBackupReminder() {
            document.getElementById('backupReminder').style.display = 'none';
            appSettings.lastReminderDate = new Date().getTime();
            saveData();
        }

        function snoozeBackup() {
            appSettings.lastReminderDate = new Date().getTime();
            saveData();
        }

        function closeModal() {
            document.getElementById('backupModal').style.display = 'none';
        }

        function updateBackupStatus() {
            const lastBackup = appSettings.lastBackupDate;
            const statusElement = document.getElementById('backupStatus');
            const dateElement = document.getElementById('lastBackupDate');
            
            if (lastBackup) {
                const backupDate = new Date(lastBackup);
                dateElement.textContent = backupDate.toLocaleDateString('en-IN', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                statusElement.style.display = 'block';
            }
        }

        function autoBackup() {
            const backupData = {
                version: '1.3',
                exportDate: new Date().toISOString(),
                trips: trips,
                fuelLogs: fuelLogs,
                serviceLogs: serviceLogs,
                customLocations: customLocations,
                vehicleDetails: vehicleDetails,
                insuranceLogs: insuranceLogs
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            
            const now = new Date();
            const filename = `trip_fuel_backup_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}.json`;
            
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
            
            appSettings.lastBackupDate = now.getTime();
            saveData();
            updateBackupStatus();
            
            document.getElementById('backupReminder').style.display = 'none';
            
            alert(`✅ Backup created successfully!\nFile: ${filename}`);
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file || !file.name.endsWith('.json')) {
                alert('Please select a valid JSON backup file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (!backupData.trips && !backupData.fuelLogs && !backupData.serviceLogs) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    const confirmMessage = `This will restore data from the backup file. This will REPLACE your current data. Continue?`;
                    
                    if (confirm(confirmMessage)) {
                        trips = backupData.trips || [];
                        fuelLogs = backupData.fuelLogs || [];
                        serviceLogs = backupData.serviceLogs || [];
                        customLocations = backupData.customLocations || [];
                        vehicleDetails = backupData.vehicleDetails || {};
                        insuranceLogs = backupData.insuranceLogs || [];
                        
                        saveData(); // This will also sort the imported data
                        displayTrips();
                        displayFuelLogs();
                        displayServiceLogs();
                        displayVehicleInfo();
                        displayInsuranceLogs();
                        updateStats();
                        populateLocationDropdown();
                        
                        alert(`✅ Data restored successfully!`);
                    }
                } catch (error) {
                    alert('❌ Error reading backup file. Please make sure it\'s a valid backup file.');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
            fileInput.value = '';
        }

        function scheduleReminders() {
            const choice = confirm('Would you like backup reminders?\n\nOK = Weekly reminders\nCancel = Turn off reminders');
            
            if (choice) {
                appSettings.backupReminders = true;
                appSettings.reminderFrequency = 7;
                alert('✅ Weekly backup reminders enabled!');
            } else {
                appSettings.backupReminders = false;
                alert('⏸️ Backup reminders disabled.');
            }
            
            saveData();
        }

        function displayTrips() {
            const container = document.getElementById('tripsList');
            
            if (trips.length === 0) {
                container.innerHTML = `<div class="empty-state"><div style="font-size: 48px;">📝</div><h3>No trip logs yet</h3><p>Add your first trip log above to get started!</p></div>`;
                return;
            }
            
            container.innerHTML = trips.map(trip => {
                const distance = trip.distance || (trip.endOdometer - trip.startOdometer);
                const purposeIcon = getPurposeIcon(trip.purpose);
                
                // Calculate cost dynamically on display
                const cost = calculateTripCost(distance, trip.date);
                const costDisplay = cost > 0 ? `<strong>Est. Cost:</strong> ₹${cost.toFixed(2)}<br>` : '';
                
                return `
                    <div class="record">
                        <div class="record-header">
                            <span class="record-date">${formatDate(trip.date)}</span>
                            <button class="record-delete" onclick="deleteTrip(${trip.id})">Delete</button>
                        </div>
                        <div class="record-details">
                            ${trip.startingLocation ? `<strong>From:</strong> ${trip.startingLocation}<br>` : ''}
                            ${trip.purpose ? `<strong>Purpose:</strong> ${purposeIcon} ${trip.purpose}<br>` : ''}
                            <strong>Distance:</strong> ${distance} km (${trip.startOdometer} → ${trip.endOdometer})<br>
                            ${costDisplay}
                            <strong>Range:</strong> ${trip.remainingRange || 'N/A'} km<br>
                            ${trip.notes ? `<strong>Notes:</strong> ${trip.notes}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getPurposeIcon(purpose) {
            const icons = {
                'Medical': '🏥', 'Shopping': '🛒', 'Family Visit': '👨‍👩‍👧‍👦',
                'Religious': '🕉️', 'Banking': '🏦', 'Social': '👥',
                'Leisure': '🎯', 'Maintenance': '🔧', 'Other': '📝'
            };
            return icons[purpose] || '📝';
        }

        function displayFuelLogs() {
            const container = document.getElementById('fuelList');
            
            if (fuelLogs.length === 0) {
                container.innerHTML = `<div class="empty-state"><div style="font-size: 48px;">⛽</div><h3>No fuel logs yet</h3><p>Add your first fuel log above to get started!</p></div>`;
                return;
            }
            
            container.innerHTML = fuelLogs.map(fuel => {
                const pricePerLitre = fuel.amount > 0 ? (fuel.cost / fuel.amount).toFixed(2) : 0;
                return `
                    <div class="record">
                        <div class="record-header">
                            <span class="record-date">${formatDate(fuel.date)}</span>
                            <button class="record-delete" onclick="deleteFuel(${fuel.id})">Delete</button>
                        </div>
                        <div class="record-details">
                            <strong>Odometer:</strong> ${fuel.odometer} km<br>
                            <strong>Fuel:</strong> ${fuel.amount} L @ ₹${pricePerLitre}/L<br>
                            <strong>Total Cost:</strong> ₹${fuel.cost}<br>
                            <strong>Range:</strong> ${fuel.rangeBefore || 'N/A'} km → ${fuel.rangeAfter || 'N/A'} km<br>
                            ${fuel.station ? `<strong>Station:</strong> ${fuel.station}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function displayServiceLogs() {
            const container = document.getElementById('serviceLogList');
            if (serviceLogs.length === 0) {
                container.innerHTML = `<div class="empty-state"><div style="font-size: 48px;">🛠️</div><h3>No service logs yet</h3><p>Add your car's service history above.</p></div>`;
                return;
            }
            
            container.innerHTML = serviceLogs.map(log => `
                <div class="record">
                    <div class="record-header">
                        <span class="record-date">${formatDate(log.date)}</span>
                        <button class="record-delete" onclick="deleteServiceLog(${log.id})">Delete</button>
                    </div>
                    <div class="record-details">
                        <strong>Center:</strong> ${log.center}<br>
                        <strong>Odometer:</strong> ${log.odometer} km<br>
                        <strong>Cost:</strong> ₹${log.cost.toFixed(2)}<br>
                        <strong>Type:</strong> ${log.type}<br>
                        ${log.description ? `<strong>Work:</strong> ${log.description}<br>` : ''}
                        ${log.parts ? `<strong>Parts:</strong> ${log.parts}<br>` : ''}
                        ${log.invoice ? `<strong>Invoice:</strong> ${log.invoice}` : ''}
                    </div>
                </div>
            `).join('');
        }

        function displayVehicleInfo() {
            const container = document.getElementById('vehicleInfo');
            const { make, model, year, licensePlate, engineNumber, chassisNumber } = vehicleDetails;

            const hasDetails = make || model || year || licensePlate || engineNumber || chassisNumber;

            if (!hasDetails) {
                container.innerHTML = `<div class="empty-state"><div style="font-size: 48px;">🚗</div><h3>No Vehicle Information</h3><p>Add your vehicle's details using the form below.</p></div>`;
            } else {
                 container.innerHTML = `
                    <h3>My Vehicle</h3>
                    <div class="vehicle-info-grid">
                        <div class="vehicle-info-item"><span class="vehicle-info-label">Make</span><span class="vehicle-info-value">${make || 'N/A'}</span></div>
                        <div class="vehicle-info-item"><span class="vehicle-info-label">Model</span><span class="vehicle-info-value">${model || 'N/A'}</span></div>
                        <div class="vehicle-info-item"><span class="vehicle-info-label">Year</span><span class="vehicle-info-value">${year || 'N/A'}</span></div>
                        <div class="vehicle-info-item"><span class="vehicle-info-label">License Plate</span><span class="vehicle-info-value">${licensePlate || 'N/A'}</span></div>
                        <div class="vehicle-info-item"><span class="vehicle-info-label">Engine No.</span><span class="vehicle-info-value">${engineNumber || 'N/A'}</span></div>
                        <div class="vehicle-info-item"><span class="vehicle-info-label">Chassis No.</span><span class="vehicle-info-value">${chassisNumber || 'N/A'}</span></div>
                    </div>`;
            }

            document.getElementById('vehicleMake').value = make || '';
            document.getElementById('vehicleModel').value = model || '';
            document.getElementById('vehicleYear').value = year || '';
            document.getElementById('licensePlate').value = licensePlate || '';
            document.getElementById('engineNumber').value = engineNumber || '';
            document.getElementById('chassisNumber').value = chassisNumber || '';
        }
        
        function displayInsuranceLogs() {
            const container = document.getElementById('insuranceLogList');

            if (insuranceLogs.length === 0) {
                container.innerHTML = `<div class="empty-state"><div style="font-size: 48px;">🛡️</div><h3>No insurance logs</h3><p>Add your current policy details above.</p></div>`;
                return;
            }
            
            // Sort by validity date descending
            insuranceLogs.sort((a,b) => new Date(b.validity) - new Date(a.validity));

            container.innerHTML = insuranceLogs.map(log => {
                return `
                    <div class="record">
                        <div class="record-header">
                            <span class="record-date">Expires: ${formatDate(log.validity)}</span>
                            <button class="record-delete" onclick="deleteInsuranceLog(${log.id})">Delete</button>
                        </div>
                        <div class="record-details">
                            <strong>Provider:</strong> ${log.provider}<br>
                            <strong>Policy No:</strong> ${log.policyNumber}<br>
                            ${log.coverage ? `<strong>Coverage:</strong> ${log.coverage}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            updateMonthlySummary();
            
            const container = document.getElementById('statsContainer');
            
            if (trips.length === 0 && fuelLogs.length === 0) {
                container.innerHTML = `<div class="empty-state"><div style="font-size: 48px;">📊</div><h3>No data for statistics</h3><p>Add some trip and fuel logs to see stats.</p></div>`;
                return;
            }
            
            const totalDistance = trips.reduce((sum, trip) => sum + (trip.distance || (trip.endOdometer - trip.startOdometer)), 0);
            const totalTrips = trips.length;
            const totalFuelCost = fuelLogs.reduce((sum, fuel) => sum + fuel.cost, 0);
            const totalFuelAmount = fuelLogs.reduce((sum, fuel) => sum + fuel.amount, 0);
            const avgFuelPrice = totalFuelAmount > 0 ? (totalFuelCost / totalFuelAmount) : 0;
            
            let fuelEfficiency = 0;
            if (fuelLogs.length >= 2) {
                const sortedFuels = [...fuelLogs].sort((a, b) => new Date(a.date) - new Date(b.date));
                let totalDistanceBetweenFuels = 0;
                let totalFuelUsed = 0;
                
                for (let i = 1; i < sortedFuels.length; i++) {
                    const distanceBetween = sortedFuels[i].odometer - sortedFuels[i-1].odometer;
                    if (distanceBetween > 0 && distanceBetween < 1000) { // Add sanity check
                        totalDistanceBetweenFuels += distanceBetween;
                        totalFuelUsed += sortedFuels[i-1].amount;
                    }
                }
                
                if (totalFuelUsed > 0) {
                    fuelEfficiency = totalDistanceBetweenFuels / totalFuelUsed;
                }
            }
            
            container.innerHTML = `
                <div class="stats">
                    <h3>📊 Overall Statistics</h3>
                    <div class="stat-grid">
                        <div class="stat-item"><span class="stat-value">${totalTrips}</span><span class="stat-label">Total Trips</span></div>
                        <div class="stat-item"><span class="stat-value">${totalDistance}</span><span class="stat-label">Total Distance (km)</span></div>
                        <div class="stat-item"><span class="stat-value">₹${totalFuelCost.toFixed(0)}</span><span class="stat-label">Total Fuel Cost</span></div>
                        <div class="stat-item"><span class="stat-value">${totalFuelAmount.toFixed(1)}</span><span class="stat-label">Total Fuel (L)</span></div>
                        <div class="stat-item"><span class="stat-value">₹${avgFuelPrice.toFixed(2)}</span><span class="stat-label">Avg. Price/Litre</span></div>
                        <div class="stat-item"><span class="stat-value">${fuelEfficiency > 0 ? fuelEfficiency.toFixed(1) : '--'}</span><span class="stat-label">Fuel Efficiency (km/L)</span></div>
                    </div>
                </div>
            `;
        }

        function searchTrips() {
            const query = document.getElementById('tripSearch').value.toLowerCase();
            const filteredTrips = trips.filter(trip => 
                Object.values(trip).some(val => String(val).toLowerCase().includes(query))
            );
            displayFilteredTrips(filteredTrips);
        }

        function displayFilteredTrips(filteredTrips) {
             const container = document.getElementById('tripsList');
             if (filteredTrips.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>No trips match your search.</p></div>`;
                return;
             }
             container.innerHTML = filteredTrips.map(trip => {
                const distance = trip.distance || (trip.endOdometer - trip.startOdometer);
                const purposeIcon = getPurposeIcon(trip.purpose);
                
                // Also calculate cost dynamically for filtered trips
                const cost = calculateTripCost(distance, trip.date);
                const costDisplay = cost > 0 ? `<strong>Est. Cost:</strong> ₹${cost.toFixed(2)}<br>` : '';

                return `
                    <div class="record">
                        <div class="record-header">
                            <span class="record-date">${formatDate(trip.date)}</span>
                            <button class="record-delete" onclick="deleteTrip(${trip.id})">Delete</button>
                        </div>
                        <div class="record-details">
                            ${trip.startingLocation ? `<strong>From:</strong> ${trip.startingLocation}<br>` : ''}
                            ${trip.purpose ? `<strong>Purpose:</strong> ${purposeIcon} ${trip.purpose}<br>` : ''}
                            <strong>Distance:</strong> ${distance} km (${trip.startOdometer} → ${trip.endOdometer})<br>
                            ${costDisplay}
                            <strong>Range:</strong> ${trip.remainingRange || 'N/A'} km<br>
                            ${trip.notes ? `<strong>Notes:</strong> ${trip.notes}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function searchFuel() {
            const query = document.getElementById('fuelSearch').value.toLowerCase();
            const filteredFuel = fuelLogs.filter(fuel => 
                 Object.values(fuel).some(val => String(val).toLowerCase().includes(query))
            );
            displayFilteredFuel(filteredFuel);
        }

        function displayFilteredFuel(filteredFuel) {
            const container = document.getElementById('fuelList');
            if (filteredFuel.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>No fuel logs match your search.</p></div>`;
                return;
            }
            container.innerHTML = filteredFuel.map(fuel => {
                const pricePerLitre = fuel.amount > 0 ? (fuel.cost / fuel.amount).toFixed(2) : 0;
                return `
                    <div class="record">
                        <div class="record-header">
                            <span class="record-date">${formatDate(fuel.date)}</span>
                            <button class="record-delete" onclick="deleteFuel(${fuel.id})">Delete</button>
                        </div>
                        <div class="record-details">
                            <strong>Odometer:</strong> ${fuel.odometer} km<br>
                            <strong>Fuel:</strong> ${fuel.amount} L @ ₹${pricePerLitre}/L<br>
                            <strong>Total Cost:</strong> ₹${fuel.cost}<br>
                            <strong>Range:</strong> ${fuel.rangeBefore || 'N/A'} km → ${fuel.rangeAfter || 'N/A'} km<br>
                            ${fuel.station ? `<strong>Station:</strong> ${fuel.station}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteTrip(id) {
            if (confirm('Are you sure you want to delete this trip log?')) {
                trips = trips.filter(trip => trip.id !== id);
                saveData();
                displayTrips();
                updateStats();
            }
        }

        function deleteFuel(id) {
           if (confirm('Are you sure you want to delete this fuel log?')) {
               fuelLogs = fuelLogs.filter(fuel => fuel.id !== id);
               saveData();
               displayFuelLogs();
               displayTrips(); // Refresh trips to reflect potential cost changes
               updateStats();
           }
        }

        function deleteServiceLog(id) {
            if (confirm('Are you sure you want to delete this service log?')) {
                serviceLogs = serviceLogs.filter(log => log.id !== id);
                saveData();
                displayServiceLogs();
            }
        }
       
       function deleteInsuranceLog(id) {
           if (confirm('Are you sure you want to delete this insurance log?')) {
               insuranceLogs = insuranceLogs.filter(log => log.id !== id);
               saveData();
               displayInsuranceLogs();
           }
       }

       function exportData(type) {
           let data = '';
           let filename = '';
           
           if (type === 'trips') {
               data = 'Date,Starting Location,Purpose,Start Odometer,End Odometer,Distance,Estimated Cost,Remaining Range,Notes\n';
               data += trips.map(trip => {
                   const distance = trip.distance || (trip.endOdometer - trip.startOdometer);
                   const cost = calculateTripCost(distance, trip.date);
                   return `"${trip.date}","${trip.startingLocation || ''}","${trip.purpose || ''}","${trip.startOdometer}","${trip.endOdometer}","${distance}","${cost.toFixed(2)}","${trip.remainingRange}","${trip.notes}"`;
               }).join('\n');
               filename = `trip_logs_${new Date().toISOString().split('T')[0]}.csv`;
           } else if (type === 'fuel') {
               data = 'Date,Odometer,Range Before,Fuel Amount,Cost,Range After,Price per Litre,Station\n';
               data += fuelLogs.map(fuel => {
                   const pricePerLitre = (fuel.cost / fuel.amount).toFixed(2);
                   return `"${fuel.date}","${fuel.odometer}","${fuel.rangeBefore}","${fuel.amount}","${fuel.cost}","${fuel.rangeAfter}","${pricePerLitre}","${fuel.station}"`;
               }).join('\n');
               filename = `fuel_logs_${new Date().toISOString().split('T')[0]}.csv`;
           }
           
           const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
           const url = window.URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = filename;
           a.click();
           window.URL.revokeObjectURL(url);
           
           alert(`✅ ${type === 'trips' ? 'Trip' : 'Fuel'} logs exported successfully!`);
       }

       function formatDate(dateString) {
           const date = new Date(dateString);
           const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
           return new Date(date.toLocaleString('en-US', { timeZone: userTimezone })).toLocaleDateString('en-IN', {
               day: 'numeric',
               month: 'short',
               year: 'numeric'
           });
       }
   </script>
</body>
</html>
