<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Trip Logger</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöó</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%234CAF50'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>üöó</text></svg>">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Trip Logger">
    <style>
    * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 414px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }

        .tab-content {
            display: none;
            padding: 20px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .section-divider {
            border-top: 1px solid #dee2e6;
            margin: 30px 0;
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            color: #212529;
            border: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            color: white;
            border: none;
        }

        .record {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .record-actions {
            display: flex;
            gap: 8px;
        }

        .record-date {
            font-weight: 600;
            color: #4CAF50;
        }

        .record-details {
            font-size: 14px;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .record-details strong {
            color: #333;
        }

        .stats {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .stats h3 {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .info-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            color: white;
            text-align: center;
            font-weight: bold;
            font-style: italic;
            cursor: pointer;
            font-family: serif;
            margin-left: 8px;
            line-height: 20px;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .font-size-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            min-width: 45px;
        }
        
        .monthly-summary {
            background: linear-gradient(135deg, #6f42c1, #5a32a3);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .monthly-history {
            background: linear-gradient(135deg, #e83e8c, #d91a72);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .history-year-group h4 {
            text-align: center;
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 20px;
            margin-bottom: 15px;
        }

        .history-month {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .history-month:last-child {
            margin-bottom: 0;
        }

        .month-header {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .history-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
        }
        
        .history-summary-item { text-align: center; }
        .history-summary-value { display: block; font-size: 14px; font-weight: bold; }
        .history-summary-label { font-size: 10px; opacity: 0.8; }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
        }
        .summary-item { text-align: center; }
        .summary-value { display: block; font-size: 20px; font-weight: bold; }
        .summary-label { font-size: 12px; opacity: 0.9; }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            overflow-y: auto;
            padding-top: 5vh;
            padding-bottom: 5vh;
        }

        .modal-content {
            background-color: white;
            margin: 0 auto;
            padding: 20px;
            border-radius: 12px;
            width: 95%;
            max-width: 400px;
            text-align: left;
        }
        
        .modal-content h3 { margin-bottom: 15px; color: #333; }
        .modal-content p { line-height: 1.6; color: #555; }
        .modal-content strong { color: #222; }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .btn-small {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 20px;
        }
        
        .export-section {
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .import-section {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 12px;
            border: 2px dashed #4CAF50;
        }
        .file-input { display: none; }
        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .backup-reminder {
            background: linear-gradient(135deg, #ff9500, #ff7b00);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        
        .backup-status {
            background: #e8f5e8;
            color: #2d5016;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #backToTopBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            border: none;
            outline: none;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            line-height: 50px;
            text-align: center;
        }

        .charts-container {
            margin-top: 20px;
            display: grid;
            gap: 20px;
        }

        .chart-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 15px;
        }
        .chart-box h4 { text-align: center; margin-bottom: 15px; color: #333; }
        .chart-box svg { width: 100%; height: auto; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .pie-chart-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 15px; }
        .legend-item { display: flex; align-items: center; font-size: 12px; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }

        
        .font-size-small { font-size: 14px; }
        .font-size-medium { font-size: 16px; }
        .font-size-large { font-size: 18px; }
        .font-size-xlarge { font-size: 20px; } 
    </style>
</head>
<body>
    <div class="container">
        <button class="font-size-toggle" onclick="toggleFontSize()" id="fontToggle">A+</button>
        
        <div class="header">
            <h1>üöó Trip Logger</h1>
            <p>Track your journeys and expenses</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('trips')">Trip Logs</button>
            <button class="tab" onclick="showTab('fuel')">Fuel Logs</button>
            <button class="tab" onclick="showTab('service')">Service</button>
            <button class="tab" onclick="showTab('stats')">Statistics</button>
            <button class="tab" onclick="showTab('vehicle')">Vehicle</button>
        </div>

        <div id="trips" class="tab-content active">
            <form id="tripForm">
                 <div class="form-group">
                    <label for="tripDate">Date</label>
                    <input type="date" id="tripDate" required>
                </div>
                <div class="form-group">
                    <label for="startingLocation">Starting Location *</label>
                    <select id="startingLocation" onchange="handleLocationChange(this)" required>
                        </select>
                </div>
                <div class="form-group" id="customLocationGroup" style="display: none;">
                    <label for="customLocation">Custom Starting Location</label>
                    <input type="text" id="customLocation" placeholder="Enter custom location...">
                </div>
                <div class="form-group">
                    <label for="tripPurpose">Trip Purpose *</label>
                    <select id="tripPurpose" required>
                        <option value="">Select purpose...</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Family Visit">Family Visit</option>
                        <option value="Religious">Religious</option>
                        <option value="Banking">Banking</option>
                        <option value="Social">Social</option>
                        <option value="Leisure">Leisure</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Medical">Medical</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="startOdometer">Start Odometer (km) *</label>
                    <input type="number" id="startOdometer" placeholder="e.g., 45000" required>
                </div>
                <div class="form-group">
                    <label for="endOdometer">End Odometer (km) *</label>
                    <input type="number" id="endOdometer" placeholder="e.g., 45150" required>
                </div>
                <div class="form-group">
                    <label for="remainingRange">Remaining Range (km)</label>
                    <input type="number" id="remainingRange" placeholder="e.g., 450">
                </div>
                <div class="form-group">
                    <label for="tripNotes">Trip Notes</label>
                    <textarea id="tripNotes" placeholder="Any additional notes about the trip..."></textarea>
                </div>
                <button type="submit" class="btn">Add Trip Log</button>
            </form>

            <div class="section-divider"></div>
            <div id="tripsList"></div>
        </div>

        <div id="fuel" class="tab-content">
            <form id="fuelForm">
                <div class="form-group">
                    <label for="fuelDate">Date</label>
                    <input type="date" id="fuelDate" required>
                </div>
                <div class="form-group">
                    <label for="fuelOdometer">Odometer Reading (km)</label>
                    <input type="number" id="fuelOdometer" placeholder="e.g., 45075" required>
                </div>
                <div class="form-group">
                    <label for="rangeBefore">Range Before Fuel (km)</label>
                    <input type="number" id="rangeBefore" placeholder="e.g., 50">
                </div>
                <div class="form-group">
                    <label for="fuelAmount">Fuel Amount (Litres)</label>
                    <input type="number" step="0.01" id="fuelAmount" placeholder="e.g., 45.5" required>
                </div>
                <div class="form-group">
                    <label for="fuelCost">Cost (‚Çπ)</label>
                    <input type="number" step="0.01" id="fuelCost" placeholder="e.g., 4095.50" required>
                </div>
                <div class="form-group">
                    <label for="rangeAfter">Range After Fuel (km)</label>
                    <input type="number" id="rangeAfter" placeholder="e.g., 650">
                </div>
                <div class="form-group">
                    <label for="fuelStation">Fuel Station Info</label>
                    <input type="text" id="fuelStation" placeholder="e.g., Shell Petrol Pump, MG Road">
                </div>
                <button type="submit" class="btn">Add Fuel Log</button>
            </form>
            
            <div class="section-divider"></div>
            <div id="fuelList"></div>
        </div>
        
        <div id="service" class="tab-content">
            <form id="serviceForm">
                 <div class="form-group">
                    <label for="serviceDate">Service Date</label>
                    <input type="date" id="serviceDate" required>
                </div>
                <div class="form-group">
                    <label for="serviceOdometer">Odometer Reading (km)</label>
                    <input type="number" id="serviceOdometer" placeholder="e.g., 40000" required>
                </div>
                <div class="form-group">
                    <label for="serviceCenter">Service Center</label>
                    <input type="text" id="serviceCenter" placeholder="e.g., Trident Hyundai" required>
                </div>
                <div class="form-group">
                    <label for="serviceType">Type of Service</label>
                    <select id="serviceType">
                        <option value="Periodic Maintenance">Periodic Maintenance</option>
                        <option value="Running Repair">Running Repair</option>
                        <option value="Body Work">Body Work</option>
                        <option value="Inspection">Inspection</option>
                        <option value="Wheel Alignment">Wheel Alignment & Balancing</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="workDescription">Description of Work Done</label>
                    <textarea id="workDescription" placeholder="e.g., 40,000 km service, AC gas top-up"></textarea>
                </div>
                <div class="form-group">
                    <label for="partsReplaced">Parts Replaced / Used</label>
                    <textarea id="partsReplaced" placeholder="e.g., Engine oil, oil filter, air filter"></textarea>
                </div>
                <div class="form-group">
                    <label for="serviceCost">Total Cost (‚Çπ)</label>
                    <input type="number" step="0.01" id="serviceCost" placeholder="e.g., 5500.00" required>
                </div>
                <div class="form-group">
                    <label for="invoiceNumber">Invoice/Bill Number</label>
                    <input type="text" id="invoiceNumber" placeholder="Enter invoice number (optional)">
                </div>
                <button type="submit" class="btn">Add Service Log</button>
            </form>

            <div class="section-divider"></div>
            <h3>üõ†Ô∏è Service History</h3>
            <div id="serviceLogList"></div>
        </div>

        <div id="stats" class="tab-content">
             <div id="backupReminder" class="backup-reminder" style="display: none;">
                <h3>‚ö†Ô∏è Backup Reminder</h3>
                <p>It's been a while since your last backup!</p>
                <button class="btn btn-small" onclick="autoBackup()" style="background: white; color: #ff9500; margin: 5px;">Backup Now</button>
                <button class="btn btn-small" onclick="dismissBackupReminder()" style="background: rgba(255,255,255,0.2); margin: 5px;">Remind Later</button>
            </div>
             <div id="backupStatus" class="backup-status" style="display: none;">
                <strong>‚úÖ Last backup:</strong> <span id="lastBackupDate">Never</span>
            </div>

            <div id="monthlySummary" class="monthly-summary">
                <h3>üìÖ This Month's Summary</h3>
                <div class="summary-grid" id="currentMonthStats"></div>
            </div>

            <div id="monthlyHistory" class="monthly-history">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>üìà Monthly History</h3>
                    <select id="historyYearFilter" onchange="updateMonthlyHistory()" style="padding: 8px; border-radius: 8px; border: 1px solid white; background: rgba(255,255,255,0.2); color: white;"></select>
                </div>
                <div id="historyContainer"></div>
            </div>
            
            <div class="section-divider"></div>

            <div id="statsContainer"></div>
            
            <div class="charts-container">
                <div class="chart-box">
                    <h4>Distance Per Month (Last 12 Months)</h4>
                    <div id="monthlyDistanceChart"></div>
                </div>
                 <div class="chart-box">
                    <h4>Trip Purpose Distribution</h4>
                    <div id="purposePieChart"></div>
                </div>
                <div class="chart-box">
                    <h4>Fuel Price Trend (‚Çπ per Litre)</h4>
                    <div id="fuelPriceChart"></div>
                </div>
            </div>

            <div class="export-section">
                <h3>üì§ Backup, Restore & Export</h3>
                <div class="import-section">
                    <h4>üì• Restore from Backup</h4>
                    <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData()">
                    <label for="importFile" class="file-input-label">Choose Backup File</label>
                </div>
                <button class="btn" onclick="autoBackup()" style="margin-top: 20px;">üîÑ Create Full Backup (JSON)</button>
                <button class="btn btn-secondary" onclick="exportData('trips')">Export Trip Logs (CSV)</button>
                <button class="btn btn-secondary" onclick="exportData('fuel')">Export Fuel Logs (CSV)</button>
            </div>
        </div>

        <div id="vehicle" class="tab-content">
            <div id="vehicleInfo" class="vehicle-info-card"></div>
            
            <form id="vehicleForm">
                <h3>‚úèÔ∏è Edit Vehicle Details</h3>
                <div class="form-group">
                    <label for="vehicleMake">Vehicle Make</label>
                    <input type="text" id="vehicleMake" placeholder="e.g., Maruti Suzuki">
                </div>
                <div class="form-group">
                    <label for="vehicleModel">Vehicle Model</label>
                    <input type="text" id="vehicleModel" placeholder="e.g., Swift">
                </div>
                <div class="form-group">
                    <label for="vehicleYear">Model Year</label>
                    <input type="number" id="vehicleYear" placeholder="e.g., 2023">
                </div>
                <div class="form-group">
                    <label for="licensePlate">License Plate</label>
                    <input type="text" id="licensePlate" placeholder="e.g., TN 01 AB 1234">
                </div>
                <div class="form-group">
                    <label for="engineNumber">Engine Number</label>
                    <input type="text" id="engineNumber" placeholder="Enter engine number">
                </div>
                <div class="form-group">
                    <label for="chassisNumber">Chassis Number</label>
                    <input type="text" id="chassisNumber" placeholder="Enter chassis number">
                </div>
                <button type="submit" class="btn">Save Vehicle Info</button>
            </form>
            
            <div class="section-divider"></div>

            <h3>üõ°Ô∏è Insurance History</h3>
            <form id="insuranceForm">
                 <div class="form-group">
                    <label for="insuranceProvider">Provider Name</label>
                    <input type="text" id="insuranceProvider" placeholder="e.g., Acko General Insurance" required>
                </div>
                <div class="form-group">
                    <label for="policyNumber">Policy Number</label>
                    <input type="text" id="policyNumber" placeholder="Enter policy number" required>
                </div>
                 <div class="form-group">
                    <label for="policyValidity">Validity (Expiry Date)</label>
                    <input type="date" id="policyValidity" required>
                </div>
                <div class="form-group">
                    <label for="coverageInfo">Coverage Information</label>
                    <textarea id="coverageInfo" placeholder="e.g., Comprehensive, Zero Depreciation..."></textarea>
                </div>
                <button type="submit" class="btn">Add Insurance Log</button>
            </form>

            <div id="insuranceLogList" style="margin-top: 20px;"></div>
        </div>

        <div id="editModal" class="modal"><div class="modal-content"><div id="modalHeader" class="modal-header"></div><div id="modalBody"></div></div></div>
        <div id="helpModal" class="modal"><div class="modal-content"><div id="modalHeader" class="modal-header">Calculation Logic</div><div id="helpModalBody"></div><div class="modal-buttons"><button class="btn" onclick="closeModal('helpModal')">Close</button></div></div></div>
        <div id="backupModal" class="modal">
            <div class="modal-content" style="text-align: center;">
                <h3>üíæ Regular Backup Recommended</h3>
                <p>To keep your data safe, we recommend backing up every week.</p>
                <div class="modal-buttons" style="justify-content: center;">
                    <button class="btn btn-small" onclick="autoBackup(); closeModal('backupModal');">Backup Now</button>
                    <button class="btn btn-small btn-secondary" onclick="snoozeBackup()">Remind Later</button>
                    <button class="btn btn-small btn-secondary" onclick="closeModal('backupModal')">Maybe Later</button>
                </div>
            </div>
        </div>
        
        <button onclick="scrollToTop()" id="backToTopBtn" title="Go to top">‚Üë</button>
    </div>

   <script>
        // Data Arrays
        let trips = [];
        let fuelLogs = [];
        let serviceLogs = [];
        let appSettings = {};
        let customLocations = [];
        let vehicleDetails = {};
        let insuranceLogs = [];

        /**
         * Loads all data from localStorage into the script's variables.
         */
        function loadData() {
            trips = JSON.parse(window.localStorage?.getItem('tripLogs') || '[]');
            fuelLogs = JSON.parse(window.localStorage?.getItem('fuelLogs') || '[]');
            serviceLogs = JSON.parse(window.localStorage?.getItem('serviceLogs') || '[]');
            appSettings = JSON.parse(window.localStorage?.getItem('appSettings') || '{}');
            customLocations = JSON.parse(window.localStorage?.getItem('customLocations') || '[]');
            vehicleDetails = JSON.parse(window.localStorage?.getItem('vehicleDetails') || '{}');
            insuranceLogs = JSON.parse(window.localStorage?.getItem('insuranceLogs') || '[]');
        }

        /**
         * Saves all data from the script's variables to localStorage, ensuring logs are sorted.
         */
        function saveData() {
            try {
                // Ensure all logs are sorted by date (descending) before saving
                trips.sort((a,b) => new Date(b.date) - new Date(a.date));
                fuelLogs.sort((a,b) => new Date(b.date) - new Date(a.date));
                serviceLogs.sort((a,b) => new Date(b.date) - new Date(a.date));
                insuranceLogs.sort((a,b) => new Date(b.validity) - new Date(a.validity));

                window.localStorage?.setItem('tripLogs', JSON.stringify(trips));
                window.localStorage?.setItem('fuelLogs', JSON.stringify(fuelLogs));
                window.localStorage?.setItem('serviceLogs', JSON.stringify(serviceLogs));
                window.localStorage?.setItem('appSettings', JSON.stringify(appSettings));
                window.localStorage?.setItem('customLocations', JSON.stringify(customLocations));
                window.localStorage?.setItem('vehicleDetails', JSON.stringify(vehicleDetails));
                window.localStorage?.setItem('insuranceLogs', JSON.stringify(insuranceLogs));
            } catch (e) {
                console.error('Could not save to localStorage:', e);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tripDate').value = today;
            document.getElementById('fuelDate').value = today;
            document.getElementById('serviceDate').value = today;
            document.getElementById('policyValidity').value = today;
            
            applyFontSize();
            renderAll();
            setupEventListeners();
            autoPopulateOdometerFields();
            checkBackupReminder();
        });
        
        /**
         * Central function to render all dynamic content on the page.
         */
        function renderAll() {
            displayTrips();
            displayFuelLogs();
            displayServiceLogs();
            displayVehicleInfo();
            displayInsuranceLogs();
            updateStats();
            populateLocationDropdown(document.getElementById('startingLocation'));
            updateBackupStatus();
        }

        /**
         * Sets up all the event listeners for the application.
         */
        function setupEventListeners() {
            document.getElementById('tripForm').addEventListener('submit', handleAddTrip);
            document.getElementById('fuelForm').addEventListener('submit', handleAddFuel);
            document.getElementById('serviceForm').addEventListener('submit', handleAddService);
            document.getElementById('vehicleForm').addEventListener('submit', handleSaveVehicle);
            document.getElementById('insuranceForm').addEventListener('submit', handleAddInsurance);
            window.addEventListener('scroll', handleScroll);
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'stats') {
                updateStats(); // Always refresh stats on view
            }
        }

        // --- Data Handling (Add, Edit, Delete) ---

        function handleAddTrip(e) {
            e.preventDefault();
            const form = e.target;
            const startOdometer = parseInt(form.querySelector('#startOdometer').value);
            const endOdometer = parseInt(form.querySelector('#endOdometer').value);

            if (endOdometer <= startOdometer) {
                alert('‚ùå End odometer must be greater than start odometer.');
                return;
            }

            const locationSelect = form.querySelector('#startingLocation').value;
            const customLocation = form.querySelector('#customLocation').value;
            const trip = {
                id: Date.now(),
                date: form.querySelector('#tripDate').value,
                startingLocation: locationSelect === 'Other' ? customLocation : locationSelect,
                purpose: form.querySelector('#tripPurpose').value,
                startOdometer: startOdometer,
                endOdometer: endOdometer,
                distance: endOdometer - startOdometer,
                remainingRange: form.querySelector('#remainingRange').value,
                notes: form.querySelector('#tripNotes').value
            };
            
            if (locationSelect === 'Other' && customLocation) {
                saveCustomLocation(customLocation);
            }
            
            trips.push(trip);
            saveData();
            displayTrips();
            form.reset();
            document.getElementById('tripDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('customLocationGroup').style.display = 'none';
            autoPopulateOdometerFields();
            alert(`‚úÖ Trip log added successfully!`);
        }
        
        function handleAddFuel(e) {
            e.preventDefault();
            const form = e.target;
            const fuel = {
                id: Date.now(),
                date: form.querySelector('#fuelDate').value,
                odometer: parseInt(form.querySelector('#fuelOdometer').value),
                rangeBefore: form.querySelector('#rangeBefore').value,
                amount: parseFloat(form.querySelector('#fuelAmount').value),
                cost: parseFloat(form.querySelector('#fuelCost').value),
                rangeAfter: form.querySelector('#rangeAfter').value,
                station: form.querySelector('#fuelStation').value
            };
            fuelLogs.push(fuel);
            saveData();
            renderAll(); // Rerender everything as fuel prices affect trips
            form.reset();
            document.getElementById('fuelDate').value = new Date().toISOString().split('T')[0];
            autoPopulateOdometerFields();
            alert('‚úÖ Fuel log added successfully!');
        }

        function handleAddService(e) {
            e.preventDefault();
            const form = e.target;
            const service = {
                id: Date.now(),
                date: form.querySelector('#serviceDate').value,
                odometer: parseInt(form.querySelector('#serviceOdometer').value),
                center: form.querySelector('#serviceCenter').value,
                type: form.querySelector('#serviceType').value,
                description: form.querySelector('#workDescription').value,
                parts: form.querySelector('#partsReplaced').value,
                cost: parseFloat(form.querySelector('#serviceCost').value),
                invoice: form.querySelector('#invoiceNumber').value
            };
            serviceLogs.push(service);
            saveData();
            displayServiceLogs();
            form.reset();
            document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
            autoPopulateOdometerFields();
            alert('‚úÖ Service log added successfully!');
        }
        
        function handleSaveVehicle(e) {
            e.preventDefault();
            const form = e.target;
            vehicleDetails.make = form.querySelector('#vehicleMake').value;
            vehicleDetails.model = form.querySelector('#vehicleModel').value;
            vehicleDetails.year = form.querySelector('#vehicleYear').value;
            vehicleDetails.licensePlate = form.querySelector('#licensePlate').value;
            vehicleDetails.engineNumber = form.querySelector('#engineNumber').value;
            vehicleDetails.chassisNumber = form.querySelector('#chassisNumber').value;
            saveData();
            displayVehicleInfo();
            alert('‚úÖ Vehicle information saved!');
        }

        function handleAddInsurance(e) {
            e.preventDefault();
            const form = e.target;
            const insurance = {
                id: Date.now(),
                provider: form.querySelector('#insuranceProvider').value,
                policyNumber: form.querySelector('#policyNumber').value,
                validity: form.querySelector('#policyValidity').value,
                coverage: form.querySelector('#coverageInfo').value
            };
            insuranceLogs.push(insurance);
            saveData();
            displayInsuranceLogs();
            form.reset();
            document.getElementById('policyValidity').value = new Date().toISOString().split('T')[0];
            alert('‚úÖ Insurance log added!');
        }

        function handleDelete(type, id) {
            if (!confirm(`Are you sure you want to delete this ${type} log?`)) return;

            let arr;
            switch(type) {
                case 'trip': arr = trips; break;
                case 'fuel': arr = fuelLogs; break;
                case 'service': arr = serviceLogs; break;
                case 'insurance': arr = insuranceLogs; break;
            }
            
            const index = arr.findIndex(item => item.id === id);
            if (index > -1) {
                arr.splice(index, 1);
            }

            saveData();
            renderAll();
        }

        // --- Display Functions ---
        
        function displayTrips() {
            const container = document.getElementById('tripsList');
            if (trips.length === 0) {
                container.innerHTML = `<div class="empty-state">üìù<h3>No trip logs yet</h3></div>`;
                return;
            }
            container.innerHTML = trips.map(trip => {
                const purposeIcon = getPurposeIcon(trip.purpose);
                const cost = calculateTripCost(trip.distance, trip.date);
                const costDisplay = cost > 0 ? `<strong>Est. Cost:</strong> ‚Çπ${cost.toFixed(2)}<br>` : '';
                return `
                    <div class="record">
                        <div class="record-header">
                            <span class="record-date">${formatDate(trip.date)}</span>
                            <div class="record-actions">
                                <button class="btn-warning" onclick="openEditModal('trip', ${trip.id})">Edit</button>
                                <button class="btn-danger" onclick="handleDelete('trip', ${trip.id})">Delete</button>
                            </div>
                        </div>
                        <div class="record-details">
                            ${trip.startingLocation ? `<strong>From:</strong> ${trip.startingLocation}<br>` : ''}
                            ${trip.purpose ? `<strong>Purpose:</strong> ${purposeIcon} ${trip.purpose}<br>` : ''}
                            <strong>Distance:</strong> ${trip.distance} km (${trip.startOdometer} ‚Üí ${trip.endOdometer})<br>
                            ${costDisplay}
                            <strong>Range:</strong> ${trip.remainingRange || 'N/A'} km<br>
                            ${trip.notes ? `<strong>Notes:</strong> ${trip.notes}` : ''}
                        </div>
                    </div>`;
            }).join('');
        }

        function displayFuelLogs() {
            const container = document.getElementById('fuelList');
            if (fuelLogs.length === 0) {
                container.innerHTML = `<div class="empty-state">‚õΩ<h3>No fuel logs yet</h3></div>`;
                return;
            }
            container.innerHTML = fuelLogs.map(fuel => {
                const pricePerLitre = fuel.amount > 0 ? (fuel.cost / fuel.amount).toFixed(2) : '0.00';
                return `
                    <div class="record">
                        <div class="record-header">
                            <span class="record-date">${formatDate(fuel.date)}</span>
                             <div class="record-actions">
                                <button class="btn-warning" onclick="openEditModal('fuel', ${fuel.id})">Edit</button>
                                <button class="btn-danger" onclick="handleDelete('fuel', ${fuel.id})">Delete</button>
                            </div>
                        </div>
                        <div class="record-details">
                            <strong>Odometer:</strong> ${fuel.odometer} km<br>
                            <strong>Fuel:</strong> ${fuel.amount} L @ ‚Çπ${pricePerLitre}/L<br>
                            <strong>Total Cost:</strong> ‚Çπ${fuel.cost.toFixed(2)}<br>
                            <strong>Range:</strong> ${fuel.rangeBefore || 'N/A'} km ‚Üí ${fuel.rangeAfter || 'N/A'} km<br>
                            ${fuel.station ? `<strong>Station:</strong> ${fuel.station}` : ''}
                        </div>
                    </div>`;
            }).join('');
        }
        
        function displayServiceLogs() {
            const container = document.getElementById('serviceLogList');
            if (serviceLogs.length === 0) {
                container.innerHTML = `<div class="empty-state">üõ†Ô∏è<h3>No service logs yet</h3></div>`;
                return;
            }
            container.innerHTML = serviceLogs.map(log => `
                <div class="record">
                    <div class="record-header">
                        <span class="record-date">${formatDate(log.date)}</span>
                        <div class="record-actions">
                            <button class="btn-warning" onclick="openEditModal('service', ${log.id})">Edit</button>
                            <button class="btn-danger" onclick="handleDelete('service', ${log.id})">Delete</button>
                        </div>
                    </div>
                    <div class="record-details">
                        <strong>Center:</strong> ${log.center}<br>
                        <strong>Odometer:</strong> ${log.odometer} km<br>
                        <strong>Cost:</strong> ‚Çπ${log.cost.toFixed(2)}<br>
                        <strong>Type:</strong> ${log.type}<br>
                        ${log.description ? `<strong>Work:</strong> ${log.description}<br>` : ''}
                        ${log.parts ? `<strong>Parts:</strong> ${log.parts}<br>` : ''}
                        ${log.invoice ? `<strong>Invoice:</strong> ${log.invoice}` : ''}
                    </div>
                </div>`).join('');
        }
        
        function displayInsuranceLogs() {
            const container = document.getElementById('insuranceLogList');
            if (insuranceLogs.length === 0) {
                container.innerHTML = `<div class="empty-state">üõ°Ô∏è<h3>No insurance logs</h3></div>`;
                return;
            }
            container.innerHTML = insuranceLogs.map(log => `
                <div class="record">
                    <div class="record-header">
                        <span class="record-date">Expires: ${formatDate(log.validity)}</span>
                        <div class="record-actions">
                            <button class="btn-warning" onclick="openEditModal('insurance', ${log.id})">Edit</button>
                            <button class="btn-danger" onclick="handleDelete('insurance', ${log.id})">Delete</button>
                        </div>
                    </div>
                    <div class="record-details">
                        <strong>Provider:</strong> ${log.provider}<br>
                        <strong>Policy No:</strong> ${log.policyNumber}<br>
                        ${log.coverage ? `<strong>Coverage:</strong> ${log.coverage}` : ''}
                    </div>
                </div>`).join('');
        }

        function displayVehicleInfo() {
            const { make, model, year, licensePlate, engineNumber, chassisNumber } = vehicleDetails;
            const container = document.getElementById('vehicleInfo');
            const hasDetails = make || model || year || licensePlate || engineNumber || chassisNumber;
            if (!hasDetails) {
                container.innerHTML = `<div class="empty-state">üöó<h3>No Vehicle Information</h3><p>Add vehicle details below.</p></div>`;
            } else {
                 container.innerHTML = `<h3>My Vehicle</h3>
                    <div class="vehicle-info-grid">
                        <div class="vehicle-info-item"><span class="vehicle-info-label">Make</span><span class="vehicle-info-value">${make || 'N/A'}</span></div>
                        <div class="vehicle-info-item"><span class="vehicle-info-label">Model</span><span class="vehicle-info-value">${model || 'N/A'}</span></div>
                        <div class="vehicle-info-item"><span class="vehicle-info-label">Year</span><span class="vehicle-info-value">${year || 'N/A'}</span></div>
                        <div class="vehicle-info-item"><span class="vehicle-info-label">License Plate</span><span class="vehicle-info-value">${licensePlate || 'N/A'}</span></div>
                        <div class="vehicle-info-item"><span class="vehicle-info-label">Engine No.</span><span class="vehicle-info-value">${engineNumber || 'N/A'}</span></div>
                        <div class="vehicle-info-item"><span class="vehicle-info-label">Chassis No.</span><span class="vehicle-info-value">${chassisNumber || 'N/A'}</span></div>
                    </div>`;
            }
            document.getElementById('vehicleMake').value = make || '';
            document.getElementById('vehicleModel').value = model || '';
            document.getElementById('vehicleYear').value = year || '';
            document.getElementById('licensePlate').value = licensePlate || '';
            document.getElementById('engineNumber').value = engineNumber || '';
            document.getElementById('chassisNumber').value = chassisNumber || '';
        }

        // --- Statistics & Calculations ---

        function calculateTripCost(distance, tripDate) {
            if (fuelLogs.length === 0) return 0;
            const relevantFuelLogs = fuelLogs.filter(log => new Date(log.date) <= new Date(tripDate));
            if (relevantFuelLogs.length === 0) return 0;
            const lastFuelLogForTrip = relevantFuelLogs[0]; // Already sorted descending
            const fuelPricePerLiter = lastFuelLogForTrip.amount > 0 ? lastFuelLogForTrip.cost / lastFuelLogForTrip.amount : 0;
            if (fuelPricePerLiter === 0) return 0;
            const fuelEfficiency = getAverageFuelEfficiency();
            const fuelNeeded = distance / fuelEfficiency;
            return fuelNeeded * fuelPricePerLiter;
        }

        function getAverageFuelEfficiency() {
            let fuelEfficiency = 15; // Default efficiency
            if (fuelLogs.length < 2) return fuelEfficiency;
            const sorted = [...fuelLogs].sort((a,b) => new Date(a.date) - new Date(b.date)); // Sort ascending for calculation
            let totalDistance = 0, totalFuel = 0;
            for (let i = 1; i < sorted.length; i++) {
                const dist = sorted[i].odometer - sorted[i-1].odometer;
                if (dist > 0 && dist < 1500) { // Sanity check distance
                    totalDistance += dist;
                    totalFuel += sorted[i-1].amount;
                }
            }
            return totalFuel > 0 ? totalDistance / totalFuel : fuelEfficiency;
        }

        function updateStats() {
            const now = new Date();
            const currentMonthData = updateMonthData(now.getMonth(), now.getFullYear());
            document.getElementById('currentMonthStats').innerHTML = `
                <div class="summary-item"><span class="summary-value">${currentMonthData.trips}</span><span class="summary-label">Trips</span></div>
                <div class="summary-item"><span class="summary-value">${currentMonthData.distance}</span><span class="summary-label">Total KM</span></div>
                <div class="summary-item"><span class="summary-value">‚Çπ${currentMonthData.fuelCost.toFixed(0)}</span><span class="summary-label">Fuel Cost</span></div>
                <div class="summary-item"><span class="summary-value">${currentMonthData.avgTrip.toFixed(1)}</span><span class="summary-label">Avg KM/Trip</span></div>`;

            updateMonthlyHistory();

            const statsContainer = document.getElementById('statsContainer');
            if (trips.length === 0 && fuelLogs.length === 0) {
                statsContainer.innerHTML = `<div class="empty-state">üìä<h3>No data for statistics</h3></div>`;
                return;
            }
            const totalDistance = trips.reduce((sum, trip) => sum + trip.distance, 0);
            const totalFuelCost = fuelLogs.reduce((sum, fuel) => sum + fuel.cost, 0);
            const totalServiceCost = serviceLogs.reduce((sum, log) => sum + log.cost, 0);
            const totalFuelAmount = fuelLogs.reduce((sum, fuel) => sum + fuel.amount, 0);
            const avgFuelPrice = totalFuelAmount > 0 ? (totalFuelCost / totalFuelAmount) : 0;
            const fuelEfficiency = getAverageFuelEfficiency();
            const costPerKm = totalDistance > 0 ? (totalFuelCost + totalServiceCost) / totalDistance : 0;

            statsContainer.innerHTML = `
                <div class="stats">
                    <h3>Overall Statistics <span class="info-icon" onclick="openHelpModal()">i</span></h3>
                    <div class="stat-grid">
                        <div class="stat-item"><span class="stat-value">${trips.length}</span><span class="stat-label">Total Trips</span></div>
                        <div class="stat-item"><span class="stat-value">${totalDistance}</span><span class="stat-label">Total Distance</span></div>
                        <div class="stat-item"><span class="stat-value">‚Çπ${costPerKm.toFixed(2)}</span><span class="stat-label">Cost / km</span></div>
                        <div class="stat-item"><span class="stat-value">‚Çπ${avgFuelPrice.toFixed(2)}</span><span class="stat-label">Avg. Fuel Price/L</span></div>
                        <div class="stat-item"><span class="stat-value">${fuelEfficiency.toFixed(1)}</span><span class="stat-label">Avg. Efficiency</span></div>
                        <div class="stat-item"><span class="stat-value">‚Çπ${(totalFuelCost + totalServiceCost).toFixed(0)}</span><span class="stat-label">Total Expenses</span></div>
                    </div>
                </div>`;
            
            renderMonthlyDistanceChart();
            renderFuelPriceChart();
            renderPurposePieChart();
        }

        function updateMonthData(month, year) {
            const monthTrips = trips.filter(trip => {
                const d = new Date(trip.date);
                return d.getMonth() === month && d.getFullYear() === year;
            });
            const monthFuel = fuelLogs.filter(fuel => {
                const d = new Date(fuel.date);
                return d.getMonth() === month && d.getFullYear() === year;
            });
            const distance = monthTrips.reduce((s, t) => s + t.distance, 0);
            const fuelCost = monthFuel.reduce((s, f) => s + f.cost, 0);
            return {
                trips: monthTrips.length,
                distance: distance,
                fuelCost: fuelCost,
                avgTrip: monthTrips.length > 0 ? distance / monthTrips.length : 0
            };
        }

        function updateMonthlyHistory() {
            const historyContainer = document.getElementById('historyContainer');
            const filter = document.getElementById('historyYearFilter');
            const allMonths = new Set();
            [...trips, ...fuelLogs].forEach(log => {
                const d = new Date(log.date);
                allMonths.add(`${d.getFullYear()}-${d.getMonth()}`);
            });
            
            const now = new Date();
            const groupedByYear = {};
            
            Array.from(allMonths).forEach(monthKey => {
                const [year, month] = monthKey.split('-').map(Number);
                if (year === now.getFullYear() && month === now.getMonth()) return;
                if (!groupedByYear[year]) groupedByYear[year] = [];
                groupedByYear[year].push({ year, month });
            });

            const sortedYears = Object.keys(groupedByYear).sort((a,b) => b - a);
            
            const currentFilterValue = filter.value;
            filter.innerHTML = '<option value="all">All Years</option>';
            sortedYears.forEach(year => {
                filter.innerHTML += `<option value="${year}">${year}</option>`;
            });
            filter.value = currentFilterValue && sortedYears.includes(currentFilterValue) ? currentFilterValue : (sortedYears.length > 0 ? sortedYears[0] : 'all');

            const displayYears = filter.value === 'all' ? sortedYears : [filter.value];

            if (displayYears.length === 0 || !groupedByYear[displayYears[0]]) {
                historyContainer.innerHTML = '<p style="text-align: center; opacity: 0.8;">No historical data for the selected year.</p>';
                return;
            }

            let html = '';
            displayYears.forEach(year => {
                html += `<div class="history-year-group"><h4>${year}</h4>`;
                const months = groupedByYear[year].sort((a,b) => b.month - a.month);
                months.forEach(({ month, year }) => {
                    const monthData = updateMonthData(month, year);
                    const monthName = new Date(year, month).toLocaleString('default', { month: 'long' });
                    html += `
                        <div class="history-month">
                            <div class="month-header">${monthName}</div>
                            <div class="history-summary-grid">
                                <div class="history-summary-item"><span class="history-summary-value">${monthData.trips}</span><span class="history-summary-label">Trips</span></div>
                                <div class="history-summary-item"><span class="history-summary-value">${monthData.distance}</span><span class="history-summary-label">KM</span></div>
                                <div class="history-summary-item"><span class="history-summary-value">‚Çπ${monthData.fuelCost.toFixed(0)}</span><span class="history-summary-label">Fuel</span></div>
                                <div class="history-summary-item"><span class="history-summary-value">${monthData.avgTrip.toFixed(1)}</span><span class="history-summary-label">Avg/Trip</span></div>
                            </div>
                        </div>`;
                });
                html += `</div>`;
            });
            historyContainer.innerHTML = html;
        }

        // --- Edit Modal Logic ---

        function openEditModal(type, id) {
            const modal = document.getElementById('editModal');
            const modalHeader = document.getElementById('modalHeader');
            const modalBody = document.getElementById('modalBody');

            const collections = { trip: trips, fuel: fuelLogs, service: serviceLogs, insurance: insuranceLogs };
            const forms = { trip: 'tripForm', fuel: 'fuelForm', service: 'serviceForm', insurance: 'insuranceForm' };
            const titles = { trip: "Edit Trip Log", fuel: "Edit Fuel Log", service: "Edit Service Log", insurance: "Edit Insurance Log" };

            const item = collections[type].find(i => i.id === id);
            if (!item) { console.error("Item not found for editing"); return; }

            modalHeader.textContent = titles[type];
            modalBody.innerHTML = document.getElementById(forms[type]).outerHTML;
            const formInModal = modalBody.querySelector('form');
            formInModal.id = `editForm-${type}`;
            
            if (type === 'trip') {
                populateLocationDropdown(formInModal.querySelector('#startingLocation'));
            }

            const elements = formInModal.elements;
            if (type === 'trip') {
                elements.tripDate.value = item.date;
                elements.startingLocation.value = item.startingLocation;
                elements.tripPurpose.value = item.purpose;
                elements.startOdometer.value = item.startOdometer;
                elements.endOdometer.value = item.endOdometer;
                elements.remainingRange.value = item.remainingRange;
                elements.tripNotes.value = item.notes;
            } else if (type === 'fuel') {
                elements.fuelDate.value = item.date;
                elements.fuelOdometer.value = item.odometer;
                elements.rangeBefore.value = item.rangeBefore;
                elements.fuelAmount.value = item.amount;
                elements.fuelCost.value = item.cost;
                elements.rangeAfter.value = item.rangeAfter;
                elements.fuelStation.value = item.station;
            } else if (type === 'service') {
                elements.serviceDate.value = item.date;
                elements.serviceOdometer.value = item.odometer;
                elements.serviceCenter.value = item.center;
                elements.serviceType.value = item.type;
                elements.workDescription.value = item.description;
                elements.partsReplaced.value = item.parts;
                elements.serviceCost.value = item.cost;
                elements.invoiceNumber.value = item.invoice;
            } else if (type === 'insurance') {
                elements.insuranceProvider.value = item.provider;
                elements.policyNumber.value = item.policyNumber;
                elements.policyValidity.value = item.validity;
                elements.coverageInfo.value = item.coverage;
            }

            if (type === 'trip') {
                const customLocationGroup = formInModal.querySelector('#customLocationGroup');
                const defaultLocations = ["Koyambedu Home", "Kumbakonam Srivatsam", "Bangalore Amigo"];
                if (!defaultLocations.includes(item.startingLocation) && !customLocations.includes(item.startingLocation)) {
                    elements.startingLocation.value = 'Other';
                    elements.customLocation.value = item.startingLocation;
                    if(customLocationGroup) customLocationGroup.style.display = 'block';
                }
            }
            
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save Changes';
            saveButton.className = 'btn';
            saveButton.onclick = () => saveChanges(type, id);

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.className = 'btn btn-secondary';
            cancelButton.onclick = () => closeModal('editModal');

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'modal-buttons';
            buttonContainer.appendChild(cancelButton);
            buttonContainer.appendChild(saveButton);
            formInModal.appendChild(buttonContainer);
            formInModal.querySelector('button[type="submit"]').remove();

            modal.style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function saveChanges(type, id) {
            const form = document.getElementById(`editForm-${type}`);
            const collections = { trip: trips, fuel: fuelLogs, service: serviceLogs, insurance: insuranceLogs };
            const item = collections[type].find(i => i.id === id);
            const elements = form.elements;

            if (type === 'trip') {
                item.date = elements.tripDate.value;
                item.purpose = elements.tripPurpose.value;
                item.startOdometer = parseInt(elements.startOdometer.value);
                item.endOdometer = parseInt(elements.endOdometer.value);
                item.distance = item.endOdometer - item.startOdometer;
                item.remainingRange = elements.remainingRange.value;
                item.notes = elements.tripNotes.value;
                const locationSelect = elements.startingLocation.value;
                const customLocation = elements.customLocation.value;
                item.startingLocation = locationSelect === 'Other' ? customLocation : locationSelect;
            } else if (type === 'fuel') {
                item.date = elements.fuelDate.value;
                item.odometer = parseInt(elements.fuelOdometer.value);
                item.rangeBefore = elements.rangeBefore.value;
                item.amount = parseFloat(elements.fuelAmount.value);
                item.cost = parseFloat(elements.fuelCost.value);
                item.rangeAfter = elements.rangeAfter.value;
                item.station = elements.fuelStation.value;
            } else if (type === 'service') {
                item.date = elements.serviceDate.value;
                item.odometer = parseInt(elements.serviceOdometer.value);
                item.center = elements.serviceCenter.value;
                item.type = elements.serviceType.value;
                item.description = elements.workDescription.value;
                item.parts = elements.partsReplaced.value;
                item.cost = parseFloat(elements.serviceCost.value);
                item.invoice = elements.invoiceNumber.value;
            } else if (type === 'insurance') {
                item.provider = elements.insuranceProvider.value;
                item.policyNumber = elements.policyNumber.value;
                item.validity = elements.policyValidity.value;
                item.coverage = elements.coverageInfo.value;
            }

            saveData();
            renderAll();
            closeModal('editModal');
            alert(`‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} log updated successfully!`);
        }

        // --- UTILITY FUNCTIONS ---
        
        function toggleFontSize() {
            const currentSize = appSettings.fontSize || 'medium';
            const sizes = ['small', 'medium', 'large', 'xlarge'];
            const nextIndex = (sizes.indexOf(currentSize) + 1) % sizes.length;
            appSettings.fontSize = sizes[nextIndex];
            applyFontSize();
            saveData();
        }

        function applyFontSize() {
            const container = document.querySelector('.container');
            const size = appSettings.fontSize || 'medium';
            const labels = {'small': 'A', 'medium': 'A+', 'large': 'A++', 'xlarge': 'A-'};
            container.className = 'container'; // Reset
            container.classList.add(`font-size-${size}`);
            document.getElementById('fontToggle').textContent = labels[size];
        }

        function autoBackup() {
            const backupData = {
                version: '1.7',
                exportDate: new Date().toISOString(),
                trips, fuelLogs, serviceLogs, customLocations, vehicleDetails, insuranceLogs, appSettings
            };
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const now = new Date();
            const filename = `trip_logger_backup_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}.json`;
            const a = document.createElement('a');
            a.href = window.URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(a.href);
            appSettings.lastBackupDate = now.getTime();
            saveData();
            updateBackupStatus();
            alert(`‚úÖ Backup created successfully!`);
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (!backupData || typeof backupData.trips === 'undefined') {
                        throw new Error('Invalid backup file format');
                    }
                    if (!confirm(`This will restore all data and REPLACE current logs. Continue?`)) return;
                    
                    trips = backupData.trips || [];
                    fuelLogs = backupData.fuelLogs || [];
                    serviceLogs = backupData.serviceLogs || [];
                    customLocations = backupData.customLocations || [];
                    vehicleDetails = backupData.vehicleDetails || {};
                    insuranceLogs = backupData.insuranceLogs || [];
                    appSettings = backupData.appSettings || {};

                    saveData();
                    applyFontSize();
                    renderAll();
                    alert(`‚úÖ Data restored successfully!`);
                } catch (error) {
                    alert('‚ùå Error reading backup file. Please make sure it is a valid backup.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            fileInput.value = '';
        }
        
        function updateBackupStatus() {
            const lastBackup = appSettings.lastBackupDate;
            const statusElement = document.getElementById('backupStatus');
            if (lastBackup) {
                statusElement.style.display = 'block';
                document.getElementById('lastBackupDate').textContent = formatDate(new Date(lastBackup));
            } else {
                statusElement.style.display = 'none';
            }
        }
        
        function checkBackupReminder() {
            const now = new Date().getTime();
            const lastBackup = appSettings.lastBackupDate || 0;
            const backupInterval = 7 * 24 * 60 * 60 * 1000;
            if (trips.length > 5 && (now - lastBackup > backupInterval)) {
                document.getElementById('backupModal').style.display = 'block';
                document.getElementById('backupReminder').style.display = 'block';
            }
        }
        
        function dismissBackupReminder() {
            document.getElementById('backupReminder').style.display = 'none';
            appSettings.lastReminderDate = new Date().getTime();
            saveData();
        }

        function snoozeBackup() {
             appSettings.lastReminderDate = new Date().getTime();
             saveData();
             closeModal('backupModal');
        }
        
        function getPurposeIcon(purpose) {
            const icons = { 'Medical': 'üè•', 'Shopping': 'üõí', 'Family Visit': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', 'Religious': 'üïâÔ∏è', 'Banking': 'üè¶', 'Social': 'üë•', 'Leisure': 'üéØ', 'Maintenance': 'üîß', 'Other': 'üìù' };
            return icons[purpose] || 'üìù';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            return new Date(date.toLocaleString('en-US', { timeZone: userTimezone })).toLocaleDateString('en-IN', {
                day: 'numeric', month: 'short', year: 'numeric'
            });
        }
        
        function autoPopulateOdometerFields() {
            let lastOdometer = 0;
            const allLogs = [...trips.map(t=>({date:t.date, odo:t.endOdometer})), ...fuelLogs.map(f=>({date:f.date, odo:f.odometer})), ...serviceLogs.map(s=>({date:s.date, odo:s.odometer}))]
                .filter(l => l.odo)
                .sort((a,b) => new Date(b.date) - new Date(a.date) || b.odo - a.odo);
                
            if (allLogs.length > 0) {
                 lastOdometer = allLogs[0].odo;
            }
            
            if (lastOdometer > 0) {
                 ['startOdometer', 'fuelOdometer', 'serviceOdometer'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.placeholder = `e.g., ${lastOdometer}`;
                    }
                });
            }
        }
        
        function exportData(type) {
           let data = '';
           let filename = '';
           if (type === 'trips') {
               data = 'Date,Starting Location,Purpose,Start Odometer,End Odometer,Distance,Estimated Cost,Remaining Range,Notes\n';
               data += trips.map(trip => {
                   const cost = calculateTripCost(trip.distance, trip.date);
                   const fields = [trip.date, trip.startingLocation, trip.purpose, trip.startOdometer, trip.endOdometer, trip.distance, cost.toFixed(2), trip.remainingRange, trip.notes];
                   return fields.map(field => `"${String(field || '').replace(/"/g, '""')}"`).join(',');
               }).join('\n');
               filename = `trip_logs_${new Date().toISOString().split('T')[0]}.csv`;
           } else if (type === 'fuel') {
                data = 'Date,Odometer,Amount (L),Cost (INR),Station\n';
                data += fuelLogs.map(fuel => {
                    const fields = [fuel.date, fuel.odometer, fuel.amount, fuel.cost, fuel.station];
                    return fields.map(field => `"${String(field || '').replace(/"/g, '""')}"`).join(',');
                }).join('\n');
                filename = `fuel_logs_${new Date().toISOString().split('T')[0]}.csv`;
           }

           const blob = new Blob([`\uFEFF${data}`], { type: 'text/csv;charset=utf-8;' });
           const url = window.URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = filename;
           a.click();
           window.URL.revokeObjectURL(url);
           alert(`‚úÖ ${type} logs exported successfully!`);
       }

       function populateLocationDropdown(selectElement) {
            const defaultOptionsHTML = `
                <option value="">Select starting location...</option>
                <option value="Koyambedu Home">üè† Koyambedu Home</option>
                <option value="Kumbakonam Srivatsam">üè° Kumbakonam Srivatsam</option>
                <option value="Bangalore Amigo">üè¢ Bangalore Amigo</option>
                <option value="Other">‚úèÔ∏è Other (specify below)</option>
            `;
            selectElement.innerHTML = defaultOptionsHTML;
            
            customLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = `üìç ${location}`;
                selectElement.insertBefore(option, selectElement.querySelector('option[value="Other"]'));
            });
        }
        
        function handleLocationChange(selectElement) {
            const form = selectElement.closest('form');
            const customGroup = form.querySelector('#customLocationGroup');
            if (customGroup) {
                customGroup.style.display = (selectElement.value === 'Other') ? 'block' : 'none';
            }
        }
        
        function handleScroll() {
            const btn = document.getElementById('backToTopBtn');
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        }

        function scrollToTop() {
            window.scrollTo(0, 0);
        }

        function openHelpModal() {
            const modalBody = document.getElementById('helpModalBody');
            modalBody.innerHTML = `
                <h3>Estimated Trip Cost</h3>
                <p>This is calculated dynamically by combining two factors: <strong>Fuel Price</strong> and <strong>Fuel Efficiency</strong>.</p>
                <p>The app finds the fuel price from the last fuel log entered on or before the trip's date. It then divides the trip distance by your car's overall average efficiency to estimate the fuel used, and multiplies that by the historical fuel price.</p>
                <hr style="margin: 15px 0;">
                <h3>Overall Cost / km</h3>
                <p>This is the true running cost of your vehicle. It's calculated by adding your <strong>Total Fuel Cost</strong> and <strong>Total Service Cost</strong>, then dividing by the <strong>Total Distance</strong> you've driven.</p>
                <hr style="margin: 15px 0;">
                <h3>Average Fuel Efficiency (km/L)</h3>
                <p>The app calculates this by looking at the distance traveled between all your fuel fill-ups and the amount of fuel added at each stop. It provides a reliable average over the lifetime of the logs.</p>
            `;
            document.getElementById('helpModal').style.display = 'block';
        }

        // --- CHARTING FUNCTIONS ---
        function renderMonthlyDistanceChart() {
            const container = document.getElementById('monthlyDistanceChart');
            const data = {};
            const now = new Date();
            for(let i=11; i>=0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${d.getMonth()}`;
                data[key] = { label: d.toLocaleString('default', {month:'short'}), value: 0 };
            }

            trips.forEach(trip => {
                const d = new Date(trip.date);
                const key = `${d.getFullYear()}-${d.getMonth()}`;
                if (data[key]) {
                    data[key].value += trip.distance;
                }
            });

            const chartData = Object.values(data);
            const maxValue = Math.max(...chartData.map(d => d.value));
            if (maxValue === 0) { container.innerHTML = '<p class="empty-state" style="padding: 20px 0;">Not enough data for chart.</p>'; return; }
            
            const bars = chartData.map((d, i) => {
                const barHeight = d.value / maxValue * 130;
                return `
                <g>
                    <rect y="${150 - barHeight}" x="${i * 25}" width="20" height="${barHeight}" fill="#4CAF50"></rect>
                    <text y="${145 - barHeight}" x="${i * 25 + 10}" text-anchor="middle" font-size="10" fill="#333">${Math.round(d.value)}</text>
                    <text y="165" x="${i * 25 + 10}" text-anchor="middle" font-size="10">${d.label}</text>
                </g>`}).join('');

            container.innerHTML = `<svg viewBox="0 0 300 170" preserveAspectRatio="xMidYMax meet">${bars}</svg>`;
        }
        
        function renderFuelPriceChart() {
            const container = document.getElementById('fuelPriceChart');
            if (fuelLogs.length < 2) { container.innerHTML = '<p class="empty-state" style="padding: 20px 0;">Need at least 2 fuel logs.</p>'; return; }

            const allLogsSorted = [...fuelLogs].sort((a,b) => new Date(a.date) - new Date(b.date));
            const recentLogs = allLogsSorted.slice(-20); // Show last 20 logs

            const prices = recentLogs.map(log => log.amount > 0 ? log.cost / log.amount : 0).filter(p => p > 0);
            if (prices.length < 2) { container.innerHTML = '<p class="empty-state" style="padding: 20px 0;">Need at least 2 valid fuel logs.</p>'; return; }
            
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const range = maxPrice - minPrice;
            
            const chartWidth = 280;
            const chartHeight = 120;
            let points = '', dataPoints = '', xLabels = '';

            recentLogs.forEach((log, i) => {
                const price = log.amount > 0 ? log.cost / log.amount : 0;
                const x = (i / (recentLogs.length - 1)) * chartWidth + 10;
                const y = 140 - (range > 0 ? ((price - minPrice) / range * chartHeight) : chartHeight / 2);
                points += `${x},${y} `;
                dataPoints += `<g>
                    <circle cx="${x}" cy="${y}" r="3" fill="#dc3545"></circle>
                    <text x="${x}" y="${y - 8}" text-anchor="middle" font-size="10" fill="#333">${price.toFixed(2)}</text>
                </g>`;
            });
            
            const labelIndices = [0, Math.floor((recentLogs.length - 1) / 2), recentLogs.length - 1];
            const uniqueLabelIndices = [...new Set(labelIndices)];

            xLabels = uniqueLabelIndices.map(i => {
                const log = recentLogs[i];
                const x = (i / (recentLogs.length - 1)) * chartWidth + 10;
                const dateLabel = new Date(log.date).toLocaleDateString('default', {month:'short', day:'2-digit'});
                return `<text x="${x}" y="165" text-anchor="middle" font-size="10">${dateLabel}</text>`;
            }).join('');

            container.innerHTML = `<svg viewBox="0 0 300 170" preserveAspectRatio="xMidYMax meet">
                <line x1="10" y1="140" x2="290" y2="140" stroke="#ccc" stroke-width="1"/>
                <polyline points="${points.trim()}" fill="none" stroke="#ffc107" stroke-width="2"/>
                ${dataPoints}
                ${xLabels}
            </svg>`;
        }

        function renderPurposePieChart() {
            const container = document.getElementById('purposePieChart');
            if (trips.length === 0) { container.innerHTML = '<p class="empty-state" style="padding: 20px 0;">No trips logged yet.</p>'; return; }

            const purposeCounts = trips.reduce((acc, trip) => {
                const purpose = trip.purpose || 'Other';
                acc[purpose] = (acc[purpose] || 0) + 1;
                return acc;
            }, {});

            const total = trips.length;
            const colors = ['#4CAF50', '#ffc107', '#17a2b8', '#6f42c1', '#e83e8c', '#fd7e14', '#6c757d', '#dc3545'];
            let cumulativePercent = 0;
            
            const getCoords = (percent) => [Math.cos(percent * 2 * Math.PI), Math.sin(percent * 2 * Math.PI)];

            const slices = Object.entries(purposeCounts).map(([purpose, count], i) => {
                const percent = count / total;
                const startAngle = cumulativePercent * 2 * Math.PI;
                const endAngle = (cumulativePercent + percent) * 2 * Math.PI;
                const midAngle = startAngle + (endAngle - startAngle) / 2;
                
                const [startX, startY] = getCoords(cumulativePercent);
                cumulativePercent += percent;
                const [endX, endY] = getCoords(cumulativePercent);
                const largeArcFlag = percent > 0.5 ? 1 : 0;
                
                const pathData = `M ${startX} ${startY} A 1 1 0 ${largeArcFlag} 1 ${endX} ${endY} L 0 0`;
                const labelX = Math.cos(midAngle) * 0.65;
                const labelY = Math.sin(midAngle) * 0.65;

                return { path: pathData, color: colors[i % colors.length], purpose, count, percent, labelX, labelY };
            });

            const legendItems = slices.map(slice => `
                <div class="legend-item">
                    <div class="legend-color" style="background-color:${slice.color};"></div>${slice.purpose} (${slice.count})
                </div>`).join('');
            
            const paths = slices.map(slice => `<path d="${slice.path}" fill="${slice.color}"></path>`).join('');
            const labels = slices.map(slice => {
                if (slice.percent < 0.05) return ''; // Don't label very small slices
                return `<text x="${slice.labelX}" y="${slice.labelY}" fill="white" font-size="0.12" text-anchor="middle" alignment-baseline="middle" font-weight="bold" transform="rotate(90, ${slice.labelX}, ${slice.labelY})">${(slice.percent * 100).toFixed(0)}%</text>`
            }).join('');

            container.innerHTML = `
                <svg viewBox="-1 -1 2 2" style="transform: rotate(-90deg); border-radius: 50%;">${paths}${labels}</svg>
                <div class="pie-chart-legend">${legendItems}</div>
            `;
        }

    </script>
</body>
</html>
